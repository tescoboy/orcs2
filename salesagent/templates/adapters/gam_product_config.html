{% extends "base.html" %}

{% block title %}Configure Google Ad Manager Settings - {{ product.name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Google Ad Manager Configuration</h2>
    <h3>{{ product.name }}</h3>

    <form id="gam-config-form" method="POST">
        <!-- Order Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Order Settings</h4>

        <div class="form-group">
            <label for="order_name_template">Order Name Template *</label>
            <input type="text" id="order_name_template" name="order_name_template"
                   value="{{ config.order_name_template or 'AdCP-{po_number}-{product_name}-{timestamp}' }}"
                   placeholder="AdCP-{po_number}-{product_name}-{timestamp}" required>
            <small style="color: #666;">Variables: {po_number}, {product_name}, {timestamp}, {principal_name}</small>
        </div>

        <div class="form-group">
            <label for="applied_team_ids">Team IDs (comma-separated)</label>
            <input type="text" id="applied_team_ids" name="applied_team_ids"
                   value="{{ ','.join(config.applied_team_ids|map('string')) if config.applied_team_ids else '' }}"
                   placeholder="12345, 67890">
            <small style="color: #666;">GAM team IDs for access control</small>
        </div>

        <!-- Line Item Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Line Item Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="line_item_type">Line Item Type *</label>
                <select id="line_item_type" name="line_item_type" required>
                    <option value="STANDARD" {% if config.line_item_type == 'STANDARD' %}selected{% endif %}>Standard</option>
                    <option value="SPONSORSHIP" {% if config.line_item_type == 'SPONSORSHIP' %}selected{% endif %}>Sponsorship</option>
                    <option value="NETWORK" {% if config.line_item_type == 'NETWORK' %}selected{% endif %}>Network</option>
                    <option value="HOUSE" {% if config.line_item_type == 'HOUSE' %}selected{% endif %}>House</option>
                    <option value="PRICE_PRIORITY" {% if config.line_item_type == 'PRICE_PRIORITY' %}selected{% endif %}>Price Priority</option>
                </select>
            </div>

            <div class="form-group">
                <label for="priority">Priority (1-16) *</label>
                <input type="number" id="priority" name="priority" min="1" max="16"
                       value="{{ config.priority or 8 }}" required>
                <small style="color: #666;">Lower = higher priority</small>
            </div>

            <div class="form-group">
                <label for="cost_type">Cost Type *</label>
                <select id="cost_type" name="cost_type" required>
                    <option value="CPM" {% if config.cost_type == 'CPM' %}selected{% endif %}>CPM</option>
                    <option value="CPC" {% if config.cost_type == 'CPC' %}selected{% endif %}>CPC</option>
                    <option value="CPD" {% if config.cost_type == 'CPD' %}selected{% endif %}>CPD</option>
                    <option value="CPA" {% if config.cost_type == 'CPA' %}selected{% endif %}>CPA</option>
                </select>
            </div>
        </div>

        <!-- Delivery Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Delivery Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="creative_rotation_type">Creative Rotation *</label>
                <select id="creative_rotation_type" name="creative_rotation_type" required>
                    <option value="EVEN" {% if config.creative_rotation_type == 'EVEN' %}selected{% endif %}>Even</option>
                    <option value="OPTIMIZED" {% if config.creative_rotation_type == 'OPTIMIZED' %}selected{% endif %}>Optimized</option>
                    <option value="MANUAL" {% if config.creative_rotation_type == 'MANUAL' %}selected{% endif %}>Manual</option>
                    <option value="SEQUENTIAL" {% if config.creative_rotation_type == 'SEQUENTIAL' %}selected{% endif %}>Sequential</option>
                </select>
            </div>

            <div class="form-group">
                <label for="delivery_rate_type">Delivery Pacing *</label>
                <select id="delivery_rate_type" name="delivery_rate_type" required>
                    <option value="EVENLY" {% if config.delivery_rate_type == 'EVENLY' %}selected{% endif %}>Evenly</option>
                    <option value="FRONTLOADED" {% if config.delivery_rate_type == 'FRONTLOADED' %}selected{% endif %}>Frontloaded</option>
                    <option value="AS_FAST_AS_POSSIBLE" {% if config.delivery_rate_type == 'AS_FAST_AS_POSSIBLE' %}selected{% endif %}>As Fast As Possible</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="primary_goal_type">Primary Goal Type *</label>
                <select id="primary_goal_type" name="primary_goal_type" required>
                    <option value="LIFETIME" {% if config.primary_goal_type == 'LIFETIME' %}selected{% endif %}>Lifetime</option>
                    <option value="DAILY" {% if config.primary_goal_type == 'DAILY' %}selected{% endif %}>Daily</option>
                    <option value="NONE" {% if config.primary_goal_type == 'NONE' %}selected{% endif %}>None</option>
                </select>
            </div>

            <div class="form-group">
                <label for="primary_goal_unit_type">Goal Unit Type *</label>
                <select id="primary_goal_unit_type" name="primary_goal_unit_type" required>
                    <option value="IMPRESSIONS" {% if config.primary_goal_unit_type == 'IMPRESSIONS' %}selected{% endif %}>Impressions</option>
                    <option value="CLICKS" {% if config.primary_goal_unit_type == 'CLICKS' %}selected{% endif %}>Clicks</option>
                    <option value="VIEWABLE_IMPRESSIONS" {% if config.primary_goal_unit_type == 'VIEWABLE_IMPRESSIONS' %}selected{% endif %}>Viewable Impressions</option>
                </select>
            </div>
        </div>

        <!-- Ad Unit/Placement Targeting -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Ad Unit & Placement Targeting</h4>

        <div class="form-group">
            <label for="targeted_ad_unit_ids">Targeted Ad Unit IDs</label>
            <textarea id="targeted_ad_unit_ids" name="targeted_ad_unit_ids" rows="3"
                      placeholder="One ad unit ID per line">{{ '\n'.join(config.targeted_ad_unit_ids) if config.targeted_ad_unit_ids else '' }}</textarea>
            <small style="color: #666;">Specific GAM ad unit IDs to target (one per line)</small>
        </div>

        <div class="form-group">
            <label for="targeted_placement_ids">Targeted Placement IDs</label>
            <textarea id="targeted_placement_ids" name="targeted_placement_ids" rows="2"
                      placeholder="One placement ID per line">{{ '\n'.join(config.targeted_placement_ids) if config.targeted_placement_ids else '' }}</textarea>
            <small style="color: #666;">GAM placement IDs to target (one per line)</small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="include_descendants"
                       {% if config.include_descendants != False %}checked{% endif %}>
                Include child ad units in targeting
            </label>
        </div>

        <!-- Creative Placeholders -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Creative Placeholders</h4>

        <div id="creative-placeholders">
            {% if config.creative_placeholders %}
                {% for placeholder in config.creative_placeholders %}
                <div class="creative-placeholder-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Width (px)</label>
                            <input type="number" name="placeholder_width[]" value="{{ placeholder.width }}" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Height (px)</label>
                            <input type="number" name="placeholder_height[]" value="{{ placeholder.height }}" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expected Count</label>
                            <input type="number" name="placeholder_count[]" value="{{ placeholder.expected_creative_count }}" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
                    </div>
                    <label style="margin-top: 0.5rem;">
                        <input type="checkbox" name="placeholder_is_native[]" {% if placeholder.is_native %}checked{% endif %}>
                        Native creative
                    </label>
                </div>
                {% endfor %}
            {% else %}
                <!-- Default creative placeholders -->
                <div class="creative-placeholder-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Width (px)</label>
                            <input type="number" name="placeholder_width[]" value="300" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Height (px)</label>
                            <input type="number" name="placeholder_height[]" value="250" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Expected Count</label>
                            <input type="number" name="placeholder_count[]" value="1" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
                    </div>
                    <label style="margin-top: 0.5rem;">
                        <input type="checkbox" name="placeholder_is_native[]">
                        Native creative
                    </label>
                </div>
            {% endif %}
        </div>
        <button type="button" class="btn btn-secondary" onclick="addCreativePlaceholder()">Add Creative Size</button>

        <!-- Frequency Capping -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Frequency Capping</h4>

        <div id="frequency-caps">
            {% if config.frequency_caps %}
                {% for cap in config.frequency_caps %}
                <div class="frequency-cap-item" style="background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Max Impressions</label>
                            <input type="number" name="cap_max_impressions[]" value="{{ cap.max_impressions }}" min="1" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Time Unit</label>
                            <select name="cap_time_unit[]" required>
                                <option value="MINUTE" {% if cap.time_unit == 'MINUTE' %}selected{% endif %}>Minute</option>
                                <option value="HOUR" {% if cap.time_unit == 'HOUR' %}selected{% endif %}>Hour</option>
                                <option value="DAY" {% if cap.time_unit == 'DAY' %}selected{% endif %}>Day</option>
                                <option value="WEEK" {% if cap.time_unit == 'WEEK' %}selected{% endif %}>Week</option>
                                <option value="MONTH" {% if cap.time_unit == 'MONTH' %}selected{% endif %}>Month</option>
                                <option value="LIFETIME" {% if cap.time_unit == 'LIFETIME' %}selected{% endif %}>Lifetime</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Time Range</label>
                            <input type="number" name="cap_time_range[]" value="{{ cap.time_range }}" min="1" required>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeFrequencyCap(this)">Remove</button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" class="btn btn-secondary" onclick="addFrequencyCap()">Add Frequency Cap</button>

        <!-- Competition & Exclusions -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Competition & Exclusions</h4>

        <div class="form-group">
            <label for="competitive_exclusion_labels">Competitive Exclusion Labels</label>
            <input type="text" id="competitive_exclusion_labels" name="competitive_exclusion_labels"
                   value="{{ ','.join(config.competitive_exclusion_labels) if config.competitive_exclusion_labels else '' }}"
                   placeholder="automotive, finance, travel">
            <small style="color: #666;">Comma-separated labels to prevent competitive ads</small>
        </div>

        <!-- Custom Targeting -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Custom Targeting (Key-Value Pairs)</h4>

        <div class="form-group">
            <label>GAM Custom Targeting Configuration</label>
            <p style="color: #666; font-size: 0.9em;">
                Configure custom targeting structure using existing GAM key-value pairs. These keys and values must already exist in your GAM account.
                <br><small><strong>Note:</strong> This references existing GAM keys - it does NOT create new keys in GAM. Find Key IDs and Value IDs in GAM under Inventory → Key-values.</small>
            </p>

            <!-- Custom Targeting Structure Builder -->
            <div id="keyValueBuilder" class="border rounded p-3 mb-3" style="background: #f8f9fa;">
                <div class="alert alert-info mb-3" style="font-size: 0.85em;">
                    <strong>ℹ️ How to use:</strong>
                    <ul class="mb-0" style="padding-left: 20px;">
                        <li>Build targeting expressions using existing GAM Key IDs and Value IDs</li>
                        <li>Use logical operators (AND/OR) to combine multiple criteria</li>
                        <li>The structure will be applied exactly as configured to each line item</li>
                    </ul>
                </div>

                <div id="customTargetingStructure">
                    <!-- Custom targeting structure will be built here -->
                </div>

                <button type="button" class="btn btn-sm btn-primary" onclick="addTargetingNode()">
                    + Add Targeting Criteria
                </button>
            </div>

            <!-- Hidden field to store the custom targeting structure -->
            <input type="hidden" id="custom_targeting_keys" name="custom_targeting_keys" value='{{ config.custom_targeting_keys|tojson if config.custom_targeting_keys else "{}" }}'>

            <!-- Raw JSON view (collapsible) -->
            <details>
                <summary style="cursor: pointer; color: #666; font-size: 0.9em;">View/Edit Raw GAM Targeting Structure</summary>
                <textarea id="custom_targeting_keys_raw" rows="8" class="form-control mt-2"
                          placeholder='{
  "logicalOperator": "OR",
  "children": [
    {
      "logicalOperator": "AND",
      "children": [
        {"keyId": 12345, "valueIds": [67890, 67891], "operator": "IS"}
      ]
    }
  ]
}'
                          onblur="updateFromRawJson()">{{ config.custom_targeting_keys|tojson(indent=2) if config.custom_targeting_keys else '{}' }}</textarea>
                <small class="text-muted">Enter the exact GAM custom targeting structure with Key IDs and Value IDs from your GAM account.</small>
            </details>
        </div>

        <!-- Advanced Settings -->
        <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Advanced Settings</h4>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="environment_type">Environment Type</label>
                <select id="environment_type" name="environment_type">
                    <option value="BROWSER" {% if config.environment_type == 'BROWSER' %}selected{% endif %}>Browser</option>
                    <option value="VIDEO_PLAYER" {% if config.environment_type == 'VIDEO_PLAYER' %}selected{% endif %}>Video Player</option>
                </select>
            </div>

            <div class="form-group">
                <label for="discount_type">Discount Type</label>
                <select id="discount_type" name="discount_type">
                    <option value="" {% if not config.discount_type %}selected{% endif %}>No discount</option>
                    <option value="PERCENTAGE" {% if config.discount_type == 'PERCENTAGE' %}selected{% endif %}>Percentage</option>
                    <option value="ABSOLUTE_VALUE" {% if config.discount_type == 'ABSOLUTE_VALUE' %}selected{% endif %}>Absolute Value</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="discount_value_group" style="{% if not config.discount_type %}display: none;{% endif %}">
            <label for="discount_value">Discount Value</label>
            <input type="number" id="discount_value" name="discount_value" step="0.01"
                   value="{{ config.discount_value or '' }}"
                   placeholder="Enter percentage or absolute value">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label>
                    <input type="checkbox" name="allow_overbook"
                           {% if config.allow_overbook %}checked{% endif %}>
                    Allow Overbooking
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="skip_inventory_check"
                           {% if config.skip_inventory_check %}checked{% endif %}>
                    Skip Inventory Check
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="disable_viewability_avg_revenue_optimization"
                           {% if config.disable_viewability_avg_revenue_optimization %}checked{% endif %}>
                    Disable Viewability Optimization
                </label>
            </div>
        </div>

        <!-- Video-Specific Settings -->
        <div id="video-settings" style="{% if config.environment_type != 'VIDEO_PLAYER' %}display: none;{% endif %}">
            <h4 style="margin-top: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Video Settings</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="companion_delivery_option">Companion Delivery</label>
                    <select id="companion_delivery_option" name="companion_delivery_option">
                        <option value="" {% if not config.companion_delivery_option %}selected{% endif %}>None</option>
                        <option value="OPTIONAL" {% if config.companion_delivery_option == 'OPTIONAL' %}selected{% endif %}>Optional</option>
                        <option value="AT_LEAST_ONE" {% if config.companion_delivery_option == 'AT_LEAST_ONE' %}selected{% endif %}>At Least One</option>
                        <option value="ALL" {% if config.companion_delivery_option == 'ALL' %}selected{% endif %}>All</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="video_max_duration">Max Duration (seconds)</label>
                    <input type="number" id="video_max_duration" name="video_max_duration"
                           value="{{ (config.video_max_duration // 1000) if config.video_max_duration else '' }}"
                           placeholder="30">
                </div>

                <div class="form-group">
                    <label for="skip_offset">Skip Offset (seconds)</label>
                    <input type="number" id="skip_offset" name="skip_offset"
                           value="{{ (config.skip_offset // 1000) if config.skip_offset else '' }}"
                           placeholder="5">
                </div>
            </div>
        </div>

        <!-- Native Ad Settings -->
        <div class="form-group">
            <label for="native_style_id">Native Style ID</label>
            <input type="text" id="native_style_id" name="native_style_id"
                   value="{{ config.native_style_id or '' }}"
                   placeholder="GAM native style ID (if applicable)">
        </div>

        <!-- Actions -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn">Save Configuration</button>
            <button type="button" class="btn btn-secondary" onclick="validateConfig()">Validate</button>
            <a href="{{ url_for('products.edit_product', tenant_id=tenant_id, product_id=product.product_id) }}"
               class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Custom Targeting Structure Builder Functions
let customTargetingData = null;

// Initialize custom targeting builder on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load existing custom targeting structure from the hidden field
    const existingData = document.getElementById('custom_targeting_keys').value;
    if (existingData && existingData !== '{}') {
        try {
            customTargetingData = JSON.parse(existingData);
            // Display existing structure
            displayCustomTargetingStructure(customTargetingData);
        } catch (e) {
            console.error('Error parsing existing custom targeting data:', e);
        }
    }
});

function displayCustomTargetingStructure(structure) {
    const container = document.getElementById('customTargetingStructure');
    if (!structure) {
        container.innerHTML = '<p class="text-muted">No custom targeting configured</p>';
        return;
    }

    // For now, just show the structure in a readable format
    // In a full implementation, this would be an interactive tree editor
    container.innerHTML = `
        <div class="alert alert-warning">
            <strong>Current Configuration:</strong>
            <pre style="margin-top: 10px; background: white; padding: 10px; border-radius: 4px;">
${JSON.stringify(structure, null, 2)}
            </pre>
            <small>Edit the raw JSON below to modify the targeting structure.</small>
        </div>
    `;
}

function addTargetingNode() {
    // Simplified for now - in production this would open a modal to build the structure
    alert('To configure custom targeting:\n\n1. Use the "View/Edit Raw GAM Targeting Structure" section below\n2. Enter your GAM Key IDs and Value IDs\n3. Use the structure shown in the placeholder\n\nNote: Key IDs and Value IDs must exist in your GAM account.');

    // Expand the raw editor
    const details = document.querySelector('details');
    if (details) {
        details.open = true;
    }
}

// Keep old function name for compatibility but update behavior
function addKeyValuePair(existingKey = '', existingValue = '') {
    const container = document.getElementById('keyValuePairs');
    const pairId = 'kvp_' + Date.now();

    const pairDiv = document.createElement('div');
    pairDiv.className = 'key-value-pair mb-2 p-2 border rounded';
    pairDiv.id = pairId;
    pairDiv.style.background = '#fff';

    pairDiv.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm"
                       placeholder="Key (e.g., category)"
                       value="${escapeHtml(existingKey)}"
                       onchange="updateKeyValue('${pairId}')"
                       data-role="key">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm"
                       placeholder="Value (e.g., sports)"
                       value="${escapeHtml(existingValue)}"
                       onchange="updateKeyValue('${pairId}')"
                       data-role="value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeKeyValuePair('${pairId}')">
                    Remove
                </button>
            </div>
        </div>
    `;

    container.appendChild(pairDiv);

    // If this is a new pair (not loading existing), update the data
    if (!existingKey && !existingValue) {
        updateKeyValue(pairId);
    }
}

function displayKeyValuePair(key, value) {
    addKeyValuePair(key, value);
}

function removeKeyValuePair(pairId) {
    const pairDiv = document.getElementById(pairId);
    if (pairDiv) {
        const keyInput = pairDiv.querySelector('[data-role="key"]');
        if (keyInput && keyInput.value) {
            delete keyValueData[keyInput.value];
        }
        pairDiv.remove();
        updateHiddenField();
    }
}

function updateKeyValue(pairId) {
    const pairDiv = document.getElementById(pairId);
    if (!pairDiv) return;

    const keyInput = pairDiv.querySelector('[data-role="key"]');
    const valueInput = pairDiv.querySelector('[data-role="value"]');

    if (keyInput && valueInput) {
        const key = keyInput.value.trim();
        const value = valueInput.value.trim();

        if (key) {
            // Remove old key if it was changed
            const oldKey = keyInput.getAttribute('data-old-key');
            if (oldKey && oldKey !== key) {
                delete keyValueData[oldKey];
            }

            // Set new key-value
            keyValueData[key] = value;
            keyInput.setAttribute('data-old-key', key);

            updateHiddenField();
        }
    }
}

function updateHiddenField() {
    // Update the hidden field with the current key-value data
    document.getElementById('custom_targeting_keys').value = JSON.stringify(keyValueData);

    // Also update the raw JSON textarea if it's visible
    const rawTextarea = document.getElementById('custom_targeting_keys_raw');
    if (rawTextarea) {
        rawTextarea.value = JSON.stringify(keyValueData, null, 2);
    }
}

function updateFromRawJson() {
    const rawTextarea = document.getElementById('custom_targeting_keys_raw');
    if (!rawTextarea) return;

    try {
        const newData = JSON.parse(rawTextarea.value || '{}');
        customTargetingData = newData;

        // Update the hidden field
        document.getElementById('custom_targeting_keys').value = JSON.stringify(customTargetingData);

        // Update the display
        displayCustomTargetingStructure(customTargetingData);
    } catch (e) {
        alert('Invalid JSON format. Please check your syntax and ensure you have valid GAM targeting structure.');
        // Revert to current data
        if (customTargetingData) {
            rawTextarea.value = JSON.stringify(customTargetingData, null, 2);
        }
    }
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function validateConfig() {
    // Validate creative placeholders
    const placeholders = document.querySelectorAll('.creative-placeholder-item');
    if (placeholders.length === 0) {
        alert('Please add at least one creative placeholder');
        return false;
    }

    // Validate custom targeting JSON
    const customTargeting = document.getElementById('custom_targeting_keys').value;
    if (customTargeting) {
        try {
            JSON.parse(customTargeting);
        } catch (e) {
            alert('Invalid JSON in custom targeting keys');
            return false;
        }
    }

    alert('Configuration is valid!');
    return true;
}

// Creative Placeholder Management
function addCreativePlaceholder() {
    const container = document.getElementById('creative-placeholders');
    const newItem = document.createElement('div');
    newItem.className = 'creative-placeholder-item';
    newItem.style = 'background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;';
    newItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label>Width (px)</label>
                <input type="number" name="placeholder_width[]" value="300" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Height (px)</label>
                <input type="number" name="placeholder_height[]" value="250" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Expected Count</label>
                <input type="number" name="placeholder_count[]" value="1" min="1" required>
            </div>
            <button type="button" class="btn btn-secondary" onclick="removeCreativePlaceholder(this)">Remove</button>
        </div>
        <label style="margin-top: 0.5rem;">
            <input type="checkbox" name="placeholder_is_native[]">
            Native creative
        </label>
    `;
    container.appendChild(newItem);
}

function removeCreativePlaceholder(button) {
    button.closest('.creative-placeholder-item').remove();
}

// Frequency Cap Management
function addFrequencyCap() {
    const container = document.getElementById('frequency-caps');
    const newItem = document.createElement('div');
    newItem.className = 'frequency-cap-item';
    newItem.style = 'background: #f5f5f5; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;';
    newItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label>Max Impressions</label>
                <input type="number" name="cap_max_impressions[]" value="3" min="1" required>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Time Unit</label>
                <select name="cap_time_unit[]" required>
                    <option value="MINUTE">Minute</option>
                    <option value="HOUR">Hour</option>
                    <option value="DAY" selected>Day</option>
                    <option value="WEEK">Week</option>
                    <option value="MONTH">Month</option>
                    <option value="LIFETIME">Lifetime</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label>Time Range</label>
                <input type="number" name="cap_time_range[]" value="1" min="1" required>
            </div>
            <button type="button" class="btn btn-secondary" onclick="removeFrequencyCap(this)">Remove</button>
        </div>
    `;
    container.appendChild(newItem);
}

function removeFrequencyCap(button) {
    button.closest('.frequency-cap-item').remove();
}

// Show/hide video settings based on environment type
document.getElementById('environment_type').addEventListener('change', function() {
    const videoSettings = document.getElementById('video-settings');
    if (this.value === 'VIDEO_PLAYER') {
        videoSettings.style.display = 'block';
    } else {
        videoSettings.style.display = 'none';
    }
});

// Show/hide discount value based on discount type
document.getElementById('discount_type').addEventListener('change', function() {
    const discountValueGroup = document.getElementById('discount_value_group');
    if (this.value) {
        discountValueGroup.style.display = 'block';
    } else {
        discountValueGroup.style.display = 'none';
    }
});
</script>
{% endblock %}
