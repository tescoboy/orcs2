{% extends "base.html" %}

{% block title %}Product Setup Wizard - AdCP Admin{% endblock %}

{% block content %}
<div class="wizard-container">
    <h2>Product Setup Wizard</h2>

    <!-- Inventory Sync Check -->
    <div id="inventory-check" style="display: none;">
        <div class="alert alert-warning">
            <h4>ðŸ“Š Inventory Sync Required</h4>
            <p>Before you can use the Product Setup Wizard, you need to sync your ad server inventory.</p>
            <p>This allows the wizard to discover your available ad units, targeting options, and creative formats.</p>
            <div style="margin: 20px 0;">
                <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant_id) }}" class="btn btn-primary">
                    Go to Inventory Manager â†’
                </a>
            </div>
            <p class="text-muted">After syncing your inventory, return here to set up your products.</p>
        </div>
    </div>

    <div id="wizard-content">
    <div class="wizard-progress">
        <div class="step active" data-step="1">
            <span class="step-number">1</span>
            <span class="step-title">Markets</span>
        </div>
        <div class="step" data-step="2">
            <span class="step-number">2</span>
            <span class="step-title">Analyze</span>
        </div>
        <div class="step" data-step="3">
            <span class="step-number">3</span>
            <span class="step-title">Suggestions</span>
        </div>
        <div class="step" data-step="4">
            <span class="step-number">4</span>
            <span class="step-title">Create</span>
        </div>
    </div>

    <!-- Step 1: Market Selection -->
    <div class="wizard-step" id="step-1">
        <h3>Select Your Primary Markets</h3>
        <p>Choose the markets that are most important for your advertisers. We'll create run-of-site products for each market.</p>

        <div class="market-grid">
            <h4>Top Markets</h4>
            <div class="market-options">
                <label class="market-option">
                    <input type="checkbox" name="markets" value="US" checked>
                    <span class="market-name">ðŸ‡ºðŸ‡¸ United States</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="CA">
                    <span class="market-name">ðŸ‡¨ðŸ‡¦ Canada</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="GB">
                    <span class="market-name">ðŸ‡¬ðŸ‡§ United Kingdom</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="AU">
                    <span class="market-name">ðŸ‡¦ðŸ‡º Australia</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="DE">
                    <span class="market-name">ðŸ‡©ðŸ‡ª Germany</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="FR">
                    <span class="market-name">ðŸ‡«ðŸ‡· France</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="JP">
                    <span class="market-name">ðŸ‡¯ðŸ‡µ Japan</span>
                </label>
                <label class="market-option">
                    <input type="checkbox" name="markets" value="BR">
                    <span class="market-name">ðŸ‡§ðŸ‡· Brazil</span>
                </label>
            </div>

            <h4>Add another market</h4>
            <div class="custom-market">
                <select id="country-select" class="form-control">
                    <option value="">Select a country...</option>
                </select>
                <button class="btn btn-secondary" onclick="addSelectedCountry()">Add Market</button>
            </div>
        </div>

        <div class="wizard-actions">
            <button class="btn btn-primary" onclick="nextStep()">Next: Analyze Ad Server</button>
        </div>
    </div>

    <!-- Step 2: Ad Server Analysis -->
    <div class="wizard-step" id="step-2" style="display: none;">
        <h3>Analyzing Your Ad Server Configuration</h3>
        <p>We're querying your ad server to discover audiences, formats, and placements...</p>

        <div class="analysis-progress">
            <div class="analysis-item" id="analyze-audiences">
                <span class="spinner"></span>
                <span class="analysis-text">Discovering audience segments...</span>
            </div>
            <div class="analysis-item" id="analyze-formats">
                <span class="spinner"></span>
                <span class="analysis-text">Finding custom creative formats...</span>
            </div>
            <div class="analysis-item" id="analyze-placements">
                <span class="spinner"></span>
                <span class="analysis-text">Mapping ad placements...</span>
            </div>
        </div>

        <div id="analysis-results" style="display: none;">
            <h4>What We Found</h4>
            <div class="results-grid">
                <div class="result-section">
                    <h5>Audience Segments</h5>
                    <div id="audience-list"></div>
                </div>
                <div class="result-section">
                    <h5>Key-Value Pairs</h5>
                    <div id="key-values-list"></div>
                </div>
                <div class="result-section">
                    <h5>Custom Formats</h5>
                    <div id="format-list"></div>
                </div>
                <div class="result-section">
                    <h5>Key Placements</h5>
                    <div id="placement-list"></div>
                </div>
            </div>
        </div>

        <div class="wizard-actions" style="display: none;">
            <button class="btn btn-secondary" onclick="previousStep()">Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next: Review Suggestions</button>
        </div>
    </div>

    <!-- Step 3: Product Suggestions -->
    <div class="wizard-step" id="step-3" style="display: none;">
        <h3>Suggested Products</h3>
        <p>Based on your markets and ad server configuration, we recommend creating these products:</p>

        <div style="margin: 1rem 0;">
            <p class="text-muted">You can configure pricing for each product below.</p>
        </div>

        <div id="product-suggestions">
            <!-- Suggestions will be populated here -->
        </div>

        <div class="suggestion-actions">
            <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
            <button class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
        </div>

        <div class="wizard-actions">
            <button class="btn btn-secondary" onclick="previousStep()">Back</button>
            <button class="btn btn-primary" onclick="createSelectedProducts()">Create Selected Products</button>
        </div>
    </div>

    <!-- Step 4: Creation Results -->
    <div class="wizard-step" id="step-4" style="display: none;">
        <h3>Creating Products...</h3>

        <div id="creation-progress">
            <!-- Progress will be shown here -->
        </div>

        <div id="creation-results" style="display: none;">
            <div class="alert alert-success">
                <h4>Success!</h4>
                <p>Created <span id="created-count">0</span> products successfully.</p>
            </div>

            <div class="wizard-actions">
                <a href="{{ url_for('products.list_products', tenant_id=tenant_id) }}" class="btn btn-primary">View Products</a>
                <button class="btn btn-secondary" onclick="startOver()">Create More Products</button>
            </div>
        </div>
    </div>
    </div> <!-- End wizard-content -->
</div>

<style>
.wizard-container {
    max-width: 900px;
    margin: 0 auto;
}

.wizard-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
    position: relative;
}

.wizard-progress::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #e0e0e0;
    z-index: -1;
}

.step {
    text-align: center;
    position: relative;
}

.step-number {
    display: inline-block;
    width: 40px;
    height: 40px;
    line-height: 40px;
    background: #e0e0e0;
    color: #666;
    border-radius: 50%;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.step.active .step-number {
    background: #007bff;
    color: white;
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step-title {
    display: block;
    font-size: 0.9rem;
    color: #666;
}

.market-grid {
    margin: 2rem 0;
}

.market-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0 2rem;
}

.market-option {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.market-option:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.market-option input[type="checkbox"] {
    margin-right: 0.5rem;
}

.custom-market {
    display: flex;
    gap: 1rem;
    max-width: 400px;
}

.custom-market select {
    flex: 1;
}

.analysis-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin: 0.5rem 0;
    background: #f8f9fa;
    border-radius: 4px;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.analysis-item.complete .spinner {
    display: none;
}

.analysis-item.complete::before {
    content: 'âœ“';
    color: #28a745;
    font-size: 1.5rem;
    margin-right: 1rem;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.result-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
}

.result-section h5 {
    margin-top: 0;
    color: #333;
}

.product-suggestion {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
    background: white;
}

.product-suggestion.selected {
    border-color: #007bff;
    background: #f0f8ff;
}

.suggestion-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.pricing-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pricing-type-toggle {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.pricing-type-toggle label {
    margin: 0;
    cursor: pointer;
}

.pricing-inputs {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.pricing-inputs input[type="number"] {
    width: 80px;
    padding: 0.25rem 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.suggestion-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.wizard-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #e0e0e0;
}

.wizard-actions button:only-child {
    margin-left: auto;
}

.alert {
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert h4 {
    color: inherit;
    margin-top: 0;
    margin-bottom: 0.5rem;
}
</style>

<script>
// Comprehensive list of countries with ISO codes
const countries = [
    {code: 'AF', name: 'Afghanistan', flag: 'ðŸ‡¦ðŸ‡«'},
    {code: 'AL', name: 'Albania', flag: 'ðŸ‡¦ðŸ‡±'},
    {code: 'DZ', name: 'Algeria', flag: 'ðŸ‡©ðŸ‡¿'},
    {code: 'AD', name: 'Andorra', flag: 'ðŸ‡¦ðŸ‡©'},
    {code: 'AO', name: 'Angola', flag: 'ðŸ‡¦ðŸ‡´'},
    {code: 'AG', name: 'Antigua and Barbuda', flag: 'ðŸ‡¦ðŸ‡¬'},
    {code: 'AR', name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·'},
    {code: 'AM', name: 'Armenia', flag: 'ðŸ‡¦ðŸ‡²'},
    {code: 'AT', name: 'Austria', flag: 'ðŸ‡¦ðŸ‡¹'},
    {code: 'AZ', name: 'Azerbaijan', flag: 'ðŸ‡¦ðŸ‡¿'},
    {code: 'BS', name: 'Bahamas', flag: 'ðŸ‡§ðŸ‡¸'},
    {code: 'BH', name: 'Bahrain', flag: 'ðŸ‡§ðŸ‡­'},
    {code: 'BD', name: 'Bangladesh', flag: 'ðŸ‡§ðŸ‡©'},
    {code: 'BB', name: 'Barbados', flag: 'ðŸ‡§ðŸ‡§'},
    {code: 'BY', name: 'Belarus', flag: 'ðŸ‡§ðŸ‡¾'},
    {code: 'BE', name: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª'},
    {code: 'BZ', name: 'Belize', flag: 'ðŸ‡§ðŸ‡¿'},
    {code: 'BJ', name: 'Benin', flag: 'ðŸ‡§ðŸ‡¯'},
    {code: 'BT', name: 'Bhutan', flag: 'ðŸ‡§ðŸ‡¹'},
    {code: 'BO', name: 'Bolivia', flag: 'ðŸ‡§ðŸ‡´'},
    {code: 'BA', name: 'Bosnia and Herzegovina', flag: 'ðŸ‡§ðŸ‡¦'},
    {code: 'BW', name: 'Botswana', flag: 'ðŸ‡§ðŸ‡¼'},
    {code: 'BN', name: 'Brunei', flag: 'ðŸ‡§ðŸ‡³'},
    {code: 'BG', name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬'},
    {code: 'BF', name: 'Burkina Faso', flag: 'ðŸ‡§ðŸ‡«'},
    {code: 'BI', name: 'Burundi', flag: 'ðŸ‡§ðŸ‡®'},
    {code: 'KH', name: 'Cambodia', flag: 'ðŸ‡°ðŸ‡­'},
    {code: 'CM', name: 'Cameroon', flag: 'ðŸ‡¨ðŸ‡²'},
    {code: 'CV', name: 'Cape Verde', flag: 'ðŸ‡¨ðŸ‡»'},
    {code: 'CF', name: 'Central African Republic', flag: 'ðŸ‡¨ðŸ‡«'},
    {code: 'TD', name: 'Chad', flag: 'ðŸ‡¹ðŸ‡©'},
    {code: 'CL', name: 'Chile', flag: 'ðŸ‡¨ðŸ‡±'},
    {code: 'CN', name: 'China', flag: 'ðŸ‡¨ðŸ‡³'},
    {code: 'CO', name: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´'},
    {code: 'KM', name: 'Comoros', flag: 'ðŸ‡°ðŸ‡²'},
    {code: 'CG', name: 'Congo', flag: 'ðŸ‡¨ðŸ‡¬'},
    {code: 'CD', name: 'Congo (DRC)', flag: 'ðŸ‡¨ðŸ‡©'},
    {code: 'CR', name: 'Costa Rica', flag: 'ðŸ‡¨ðŸ‡·'},
    {code: 'CI', name: 'CÃ´te d\'Ivoire', flag: 'ðŸ‡¨ðŸ‡®'},
    {code: 'HR', name: 'Croatia', flag: 'ðŸ‡­ðŸ‡·'},
    {code: 'CU', name: 'Cuba', flag: 'ðŸ‡¨ðŸ‡º'},
    {code: 'CY', name: 'Cyprus', flag: 'ðŸ‡¨ðŸ‡¾'},
    {code: 'CZ', name: 'Czech Republic', flag: 'ðŸ‡¨ðŸ‡¿'},
    {code: 'DK', name: 'Denmark', flag: 'ðŸ‡©ðŸ‡°'},
    {code: 'DJ', name: 'Djibouti', flag: 'ðŸ‡©ðŸ‡¯'},
    {code: 'DM', name: 'Dominica', flag: 'ðŸ‡©ðŸ‡²'},
    {code: 'DO', name: 'Dominican Republic', flag: 'ðŸ‡©ðŸ‡´'},
    {code: 'EC', name: 'Ecuador', flag: 'ðŸ‡ªðŸ‡¨'},
    {code: 'EG', name: 'Egypt', flag: 'ðŸ‡ªðŸ‡¬'},
    {code: 'SV', name: 'El Salvador', flag: 'ðŸ‡¸ðŸ‡»'},
    {code: 'GQ', name: 'Equatorial Guinea', flag: 'ðŸ‡¬ðŸ‡¶'},
    {code: 'ER', name: 'Eritrea', flag: 'ðŸ‡ªðŸ‡·'},
    {code: 'EE', name: 'Estonia', flag: 'ðŸ‡ªðŸ‡ª'},
    {code: 'SZ', name: 'Eswatini', flag: 'ðŸ‡¸ðŸ‡¿'},
    {code: 'ET', name: 'Ethiopia', flag: 'ðŸ‡ªðŸ‡¹'},
    {code: 'FJ', name: 'Fiji', flag: 'ðŸ‡«ðŸ‡¯'},
    {code: 'FI', name: 'Finland', flag: 'ðŸ‡«ðŸ‡®'},
    {code: 'GA', name: 'Gabon', flag: 'ðŸ‡¬ðŸ‡¦'},
    {code: 'GM', name: 'Gambia', flag: 'ðŸ‡¬ðŸ‡²'},
    {code: 'GE', name: 'Georgia', flag: 'ðŸ‡¬ðŸ‡ª'},
    {code: 'GH', name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­'},
    {code: 'GR', name: 'Greece', flag: 'ðŸ‡¬ðŸ‡·'},
    {code: 'GD', name: 'Grenada', flag: 'ðŸ‡¬ðŸ‡©'},
    {code: 'GT', name: 'Guatemala', flag: 'ðŸ‡¬ðŸ‡¹'},
    {code: 'GN', name: 'Guinea', flag: 'ðŸ‡¬ðŸ‡³'},
    {code: 'GW', name: 'Guinea-Bissau', flag: 'ðŸ‡¬ðŸ‡¼'},
    {code: 'GY', name: 'Guyana', flag: 'ðŸ‡¬ðŸ‡¾'},
    {code: 'HT', name: 'Haiti', flag: 'ðŸ‡­ðŸ‡¹'},
    {code: 'HN', name: 'Honduras', flag: 'ðŸ‡­ðŸ‡³'},
    {code: 'HU', name: 'Hungary', flag: 'ðŸ‡­ðŸ‡º'},
    {code: 'IS', name: 'Iceland', flag: 'ðŸ‡®ðŸ‡¸'},
    {code: 'IN', name: 'India', flag: 'ðŸ‡®ðŸ‡³'},
    {code: 'ID', name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©'},
    {code: 'IR', name: 'Iran', flag: 'ðŸ‡®ðŸ‡·'},
    {code: 'IQ', name: 'Iraq', flag: 'ðŸ‡®ðŸ‡¶'},
    {code: 'IE', name: 'Ireland', flag: 'ðŸ‡®ðŸ‡ª'},
    {code: 'IL', name: 'Israel', flag: 'ðŸ‡®ðŸ‡±'},
    {code: 'IT', name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹'},
    {code: 'JM', name: 'Jamaica', flag: 'ðŸ‡¯ðŸ‡²'},
    {code: 'JO', name: 'Jordan', flag: 'ðŸ‡¯ðŸ‡´'},
    {code: 'KZ', name: 'Kazakhstan', flag: 'ðŸ‡°ðŸ‡¿'},
    {code: 'KE', name: 'Kenya', flag: 'ðŸ‡°ðŸ‡ª'},
    {code: 'KI', name: 'Kiribati', flag: 'ðŸ‡°ðŸ‡®'},
    {code: 'KP', name: 'North Korea', flag: 'ðŸ‡°ðŸ‡µ'},
    {code: 'KR', name: 'South Korea', flag: 'ðŸ‡°ðŸ‡·'},
    {code: 'KW', name: 'Kuwait', flag: 'ðŸ‡°ðŸ‡¼'},
    {code: 'KG', name: 'Kyrgyzstan', flag: 'ðŸ‡°ðŸ‡¬'},
    {code: 'LA', name: 'Laos', flag: 'ðŸ‡±ðŸ‡¦'},
    {code: 'LV', name: 'Latvia', flag: 'ðŸ‡±ðŸ‡»'},
    {code: 'LB', name: 'Lebanon', flag: 'ðŸ‡±ðŸ‡§'},
    {code: 'LS', name: 'Lesotho', flag: 'ðŸ‡±ðŸ‡¸'},
    {code: 'LR', name: 'Liberia', flag: 'ðŸ‡±ðŸ‡·'},
    {code: 'LY', name: 'Libya', flag: 'ðŸ‡±ðŸ‡¾'},
    {code: 'LI', name: 'Liechtenstein', flag: 'ðŸ‡±ðŸ‡®'},
    {code: 'LT', name: 'Lithuania', flag: 'ðŸ‡±ðŸ‡¹'},
    {code: 'LU', name: 'Luxembourg', flag: 'ðŸ‡±ðŸ‡º'},
    {code: 'MG', name: 'Madagascar', flag: 'ðŸ‡²ðŸ‡¬'},
    {code: 'MW', name: 'Malawi', flag: 'ðŸ‡²ðŸ‡¼'},
    {code: 'MY', name: 'Malaysia', flag: 'ðŸ‡²ðŸ‡¾'},
    {code: 'MV', name: 'Maldives', flag: 'ðŸ‡²ðŸ‡»'},
    {code: 'ML', name: 'Mali', flag: 'ðŸ‡²ðŸ‡±'},
    {code: 'MT', name: 'Malta', flag: 'ðŸ‡²ðŸ‡¹'},
    {code: 'MH', name: 'Marshall Islands', flag: 'ðŸ‡²ðŸ‡­'},
    {code: 'MR', name: 'Mauritania', flag: 'ðŸ‡²ðŸ‡·'},
    {code: 'MU', name: 'Mauritius', flag: 'ðŸ‡²ðŸ‡º'},
    {code: 'MX', name: 'Mexico', flag: 'ðŸ‡²ðŸ‡½'},
    {code: 'FM', name: 'Micronesia', flag: 'ðŸ‡«ðŸ‡²'},
    {code: 'MD', name: 'Moldova', flag: 'ðŸ‡²ðŸ‡©'},
    {code: 'MC', name: 'Monaco', flag: 'ðŸ‡²ðŸ‡¨'},
    {code: 'MN', name: 'Mongolia', flag: 'ðŸ‡²ðŸ‡³'},
    {code: 'ME', name: 'Montenegro', flag: 'ðŸ‡²ðŸ‡ª'},
    {code: 'MA', name: 'Morocco', flag: 'ðŸ‡²ðŸ‡¦'},
    {code: 'MZ', name: 'Mozambique', flag: 'ðŸ‡²ðŸ‡¿'},
    {code: 'MM', name: 'Myanmar', flag: 'ðŸ‡²ðŸ‡²'},
    {code: 'NA', name: 'Namibia', flag: 'ðŸ‡³ðŸ‡¦'},
    {code: 'NR', name: 'Nauru', flag: 'ðŸ‡³ðŸ‡·'},
    {code: 'NP', name: 'Nepal', flag: 'ðŸ‡³ðŸ‡µ'},
    {code: 'NL', name: 'Netherlands', flag: 'ðŸ‡³ðŸ‡±'},
    {code: 'NZ', name: 'New Zealand', flag: 'ðŸ‡³ðŸ‡¿'},
    {code: 'NI', name: 'Nicaragua', flag: 'ðŸ‡³ðŸ‡®'},
    {code: 'NE', name: 'Niger', flag: 'ðŸ‡³ðŸ‡ª'},
    {code: 'NG', name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬'},
    {code: 'MK', name: 'North Macedonia', flag: 'ðŸ‡²ðŸ‡°'},
    {code: 'NO', name: 'Norway', flag: 'ðŸ‡³ðŸ‡´'},
    {code: 'OM', name: 'Oman', flag: 'ðŸ‡´ðŸ‡²'},
    {code: 'PK', name: 'Pakistan', flag: 'ðŸ‡µðŸ‡°'},
    {code: 'PW', name: 'Palau', flag: 'ðŸ‡µðŸ‡¼'},
    {code: 'PS', name: 'Palestine', flag: 'ðŸ‡µðŸ‡¸'},
    {code: 'PA', name: 'Panama', flag: 'ðŸ‡µðŸ‡¦'},
    {code: 'PG', name: 'Papua New Guinea', flag: 'ðŸ‡µðŸ‡¬'},
    {code: 'PY', name: 'Paraguay', flag: 'ðŸ‡µðŸ‡¾'},
    {code: 'PE', name: 'Peru', flag: 'ðŸ‡µðŸ‡ª'},
    {code: 'PH', name: 'Philippines', flag: 'ðŸ‡µðŸ‡­'},
    {code: 'PL', name: 'Poland', flag: 'ðŸ‡µðŸ‡±'},
    {code: 'PT', name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹'},
    {code: 'QA', name: 'Qatar', flag: 'ðŸ‡¶ðŸ‡¦'},
    {code: 'RO', name: 'Romania', flag: 'ðŸ‡·ðŸ‡´'},
    {code: 'RU', name: 'Russia', flag: 'ðŸ‡·ðŸ‡º'},
    {code: 'RW', name: 'Rwanda', flag: 'ðŸ‡·ðŸ‡¼'},
    {code: 'KN', name: 'Saint Kitts and Nevis', flag: 'ðŸ‡°ðŸ‡³'},
    {code: 'LC', name: 'Saint Lucia', flag: 'ðŸ‡±ðŸ‡¨'},
    {code: 'VC', name: 'Saint Vincent and the Grenadines', flag: 'ðŸ‡»ðŸ‡¨'},
    {code: 'WS', name: 'Samoa', flag: 'ðŸ‡¼ðŸ‡¸'},
    {code: 'SM', name: 'San Marino', flag: 'ðŸ‡¸ðŸ‡²'},
    {code: 'ST', name: 'SÃ£o TomÃ© and PrÃ­ncipe', flag: 'ðŸ‡¸ðŸ‡¹'},
    {code: 'SA', name: 'Saudi Arabia', flag: 'ðŸ‡¸ðŸ‡¦'},
    {code: 'SN', name: 'Senegal', flag: 'ðŸ‡¸ðŸ‡³'},
    {code: 'RS', name: 'Serbia', flag: 'ðŸ‡·ðŸ‡¸'},
    {code: 'SC', name: 'Seychelles', flag: 'ðŸ‡¸ðŸ‡¨'},
    {code: 'SL', name: 'Sierra Leone', flag: 'ðŸ‡¸ðŸ‡±'},
    {code: 'SG', name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬'},
    {code: 'SK', name: 'Slovakia', flag: 'ðŸ‡¸ðŸ‡°'},
    {code: 'SI', name: 'Slovenia', flag: 'ðŸ‡¸ðŸ‡®'},
    {code: 'SB', name: 'Solomon Islands', flag: 'ðŸ‡¸ðŸ‡§'},
    {code: 'SO', name: 'Somalia', flag: 'ðŸ‡¸ðŸ‡´'},
    {code: 'ZA', name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦'},
    {code: 'SS', name: 'South Sudan', flag: 'ðŸ‡¸ðŸ‡¸'},
    {code: 'ES', name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸'},
    {code: 'LK', name: 'Sri Lanka', flag: 'ðŸ‡±ðŸ‡°'},
    {code: 'SD', name: 'Sudan', flag: 'ðŸ‡¸ðŸ‡©'},
    {code: 'SR', name: 'Suriname', flag: 'ðŸ‡¸ðŸ‡·'},
    {code: 'SE', name: 'Sweden', flag: 'ðŸ‡¸ðŸ‡ª'},
    {code: 'CH', name: 'Switzerland', flag: 'ðŸ‡¨ðŸ‡­'},
    {code: 'SY', name: 'Syria', flag: 'ðŸ‡¸ðŸ‡¾'},
    {code: 'TW', name: 'Taiwan', flag: 'ðŸ‡¹ðŸ‡¼'},
    {code: 'TJ', name: 'Tajikistan', flag: 'ðŸ‡¹ðŸ‡¯'},
    {code: 'TZ', name: 'Tanzania', flag: 'ðŸ‡¹ðŸ‡¿'},
    {code: 'TH', name: 'Thailand', flag: 'ðŸ‡¹ðŸ‡­'},
    {code: 'TL', name: 'Timor-Leste', flag: 'ðŸ‡¹ðŸ‡±'},
    {code: 'TG', name: 'Togo', flag: 'ðŸ‡¹ðŸ‡¬'},
    {code: 'TO', name: 'Tonga', flag: 'ðŸ‡¹ðŸ‡´'},
    {code: 'TT', name: 'Trinidad and Tobago', flag: 'ðŸ‡¹ðŸ‡¹'},
    {code: 'TN', name: 'Tunisia', flag: 'ðŸ‡¹ðŸ‡³'},
    {code: 'TR', name: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·'},
    {code: 'TM', name: 'Turkmenistan', flag: 'ðŸ‡¹ðŸ‡²'},
    {code: 'TV', name: 'Tuvalu', flag: 'ðŸ‡¹ðŸ‡»'},
    {code: 'UG', name: 'Uganda', flag: 'ðŸ‡ºðŸ‡¬'},
    {code: 'UA', name: 'Ukraine', flag: 'ðŸ‡ºðŸ‡¦'},
    {code: 'AE', name: 'United Arab Emirates', flag: 'ðŸ‡¦ðŸ‡ª'},
    {code: 'UY', name: 'Uruguay', flag: 'ðŸ‡ºðŸ‡¾'},
    {code: 'UZ', name: 'Uzbekistan', flag: 'ðŸ‡ºðŸ‡¿'},
    {code: 'VU', name: 'Vanuatu', flag: 'ðŸ‡»ðŸ‡º'},
    {code: 'VA', name: 'Vatican City', flag: 'ðŸ‡»ðŸ‡¦'},
    {code: 'VE', name: 'Venezuela', flag: 'ðŸ‡»ðŸ‡ª'},
    {code: 'VN', name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³'},
    {code: 'YE', name: 'Yemen', flag: 'ðŸ‡¾ðŸ‡ª'},
    {code: 'ZM', name: 'Zambia', flag: 'ðŸ‡¿ðŸ‡²'},
    {code: 'ZW', name: 'Zimbabwe', flag: 'ðŸ‡¿ðŸ‡¼'}
];

let currentStep = 1;
let selectedMarkets = [];
let adServerData = {};
let suggestedProducts = [];

function nextStep() {
    if (currentStep === 1) {
        // Collect selected markets
        selectedMarkets = Array.from(document.querySelectorAll('input[name="markets"]:checked'))
            .map(cb => cb.value);

        if (selectedMarkets.length === 0) {
            alert('Please select at least one market');
            return;
        }
    }

    document.getElementById(`step-${currentStep}`).style.display = 'none';
    currentStep++;
    document.getElementById(`step-${currentStep}`).style.display = 'block';

    // Update progress
    document.querySelectorAll('.step').forEach((step, index) => {
        if (index < currentStep - 1) {
            step.classList.add('completed');
            step.classList.remove('active');
        } else if (index === currentStep - 1) {
            step.classList.add('active');
        }
    });

    // Trigger ad server analysis on step 2
    if (currentStep === 2) {
        analyzeAdServer();
    }
}

function previousStep() {
    document.getElementById(`step-${currentStep}`).style.display = 'none';
    currentStep--;
    document.getElementById(`step-${currentStep}`).style.display = 'block';
}

async function analyzeAdServer() {
    // Simulate querying ad server
    const steps = ['audiences', 'formats', 'placements'];

    for (const step of steps) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        document.getElementById(`analyze-${step}`).classList.add('complete');
    }

    // Fetch actual data from ad server
    try {
        const response = await fetch(`{{ url_for('inventory.analyze_ad_server_inventory', tenant_id=tenant_id) }}`);
        adServerData = await response.json();
        console.log('Ad server data received:', adServerData);

        // Check if inventory sync is needed
        if (adServerData.error && adServerData.properties && adServerData.properties.needs_sync) {
            // Show error message about needing to sync inventory
            document.getElementById('analysis-results').innerHTML = `
                <div class="alert alert-warning">
                    <h4>Inventory Sync Required</h4>
                    <p>${adServerData.error}</p>
                    <p>Please run the GAM inventory sync before using the Product Wizard:</p>
                    <ol>
                        <li>Go to the <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant_id) }}">GAM Inventory</a> page</li>
                        <li>Click "Sync Inventory" to fetch the latest data from GAM</li>
                        <li>Return here after the sync completes</li>
                    </ol>
                </div>
            `;
            document.getElementById('analysis-results').style.display = 'block';
            // Hide the next button since we can't proceed
            document.querySelector('#step-2 .wizard-actions').style.display = 'none';
            return;
        }

        displayAnalysisResults();
        generateProductSuggestions();

        // Show info if data is from cache
        if (adServerData.properties && adServerData.properties.from_cache) {
            const lastSync = adServerData.properties.last_sync ?
                new Date(adServerData.properties.last_sync).toLocaleString() : 'Unknown';
            console.log(`Using cached inventory data from ${lastSync}`);
        }

    } catch (error) {
        console.error('Error analyzing ad server:', error);
        // Use mock data for demo
        adServerData = {
            audiences: [
                {id: 'tech_enthusiasts', name: 'Tech Enthusiasts', size: 1200000},
                {id: 'sports_fans', name: 'Sports Fans', size: 800000},
                {id: 'luxury_shoppers', name: 'Luxury Shoppers', size: 500000}
            ],
            formats: [
                {id: 'custom_video_300x250', name: 'Custom Video Banner', type: 'video'},
                {id: 'interactive_cube', name: 'Interactive Cube Ad', type: 'rich_media'}
            ],
            placements: [
                {id: 'homepage_hero', name: 'Homepage Hero', sizes: ['970x250', '728x90']},
                {id: 'article_sidebar', name: 'Article Sidebar', sizes: ['300x250', '300x600']}
            ]
        };
        displayAnalysisResults();
        generateProductSuggestions();
    }

    document.getElementById('analysis-results').style.display = 'block';
    document.querySelector('#step-2 .wizard-actions').style.display = 'flex';
}

function displayAnalysisResults() {
    // Display audiences
    const audienceHtml = (adServerData.audiences || []).map(aud =>
        `<div class="result-item">
            <strong>${aud.name}</strong>
            <span class="badge">${aud.size ? (aud.size / 1000000).toFixed(1) + 'M users' : 'N/A'}</span>
        </div>`
    ).join('');
    document.getElementById('audience-list').innerHTML = audienceHtml || '<p>No custom audiences found</p>';

    // Display key-value pairs
    const keyValuesHtml = (adServerData.key_values || []).map(kv =>
        `<div class="result-item">
            <strong>${kv.display_name || kv.name}</strong>
            <span class="badge">${kv.values ? kv.values.length + ' values' : '0 values'}</span>
        </div>`
    ).join('');
    document.getElementById('key-values-list').innerHTML = keyValuesHtml || '<p>No key-value pairs found in GAM</p>';

    // Display formats
    const formatHtml = (adServerData.formats || []).map(fmt =>
        `<div class="result-item">
            <strong>${fmt.name}</strong>
            <span class="badge">${fmt.type}</span>
        </div>`
    ).join('');
    document.getElementById('format-list').innerHTML = formatHtml || '<p>No custom formats found</p>';

    // Display placements
    const placementHtml = (adServerData.placements || []).map(plc =>
        `<div class="result-item">
            <strong>${plc.name}</strong>
            <span class="badge">${plc.sizes ? plc.sizes.join(', ') : 'N/A'}</span>
        </div>`
    ).join('');
    document.getElementById('placement-list').innerHTML = placementHtml || '<p>Standard placements only</p>';
}

function generateProductSuggestions() {
    suggestedProducts = [];

    // 1. Run-of-site products for each market
    selectedMarkets.forEach(market => {
        const country = countries.find(c => c.code === market) || {name: market};
        suggestedProducts.push({
            type: 'run_of_site',
            name: `Run of Site - ${country.name}`,
            product_id: `ros_display_${market.toLowerCase()}`,
            description: `Non-guaranteed display advertising across all inventory in ${country.name}`,
            formats: ['display_300x250', 'display_728x90', 'display_320x50'],
            countries: [market],
            delivery_type: 'non_guaranteed',
            price_guidance: {min: 2.0, max: 10.0}
        });
    });

    // 2. Key-value based products (for important custom targeting)
    if (adServerData.key_values && adServerData.key_values.length > 0) {
        // Create products for the first few key-value pairs with multiple values
        adServerData.key_values.slice(0, 5).forEach(kv => {
            if (kv.values && kv.values.length > 0) {
                selectedMarkets.forEach(market => {
                    const country = countries.find(c => c.code === market) || {name: market};
                    suggestedProducts.push({
                        type: 'key_value_targeting',
                        name: `${kv.display_name || kv.name} - ${country.name}`,
                        product_id: `kv_${kv.name}_${market.toLowerCase()}`.replace(/\W+/g, '_'),
                        description: `Target content tagged with ${kv.display_name || kv.name} in ${country.name}`,
                        formats: ['display_300x250', 'display_728x90', 'native_infeed'],
                        countries: [market],
                        delivery_type: 'non_guaranteed',
                        price_guidance: {min: 3.0, max: 15.0},
                        targeting_template: {
                            key_value_pairs: {
                                [kv.name]: kv.values.slice(0, 5).map(v => v.name)
                            }
                        }
                    });
                });
            }
        });
    }

    // 3. Audience-based products
    (adServerData.audiences || []).forEach(audience => {
        if (audience.size > 100000) { // Only for significant audiences
            suggestedProducts.push({
                type: 'audience',
                name: `${audience.name} Targeting`,
                product_id: `audience_${audience.id}`,
                description: `Target ${audience.name} audience segment (${(audience.size / 1000000).toFixed(1)}M users)`,
                formats: ['display_300x250', 'display_728x90', 'native_infeed'],
                countries: selectedMarkets,
                delivery_type: 'non_guaranteed',
                price_guidance: {min: 5.0, max: 20.0},
                targeting_template: {
                    audience_targets: {segments: [audience.id]}
                }
            });
        }
    });

    // 4. Custom format products for each market
    (adServerData.formats || []).forEach(format => {
        selectedMarkets.forEach(market => {
            const country = countries.find(c => c.code === market) || {name: market};
            suggestedProducts.push({
                type: 'custom_format',
                name: `${format.name} - ${country.name}`,
                product_id: `${format.id}_${market.toLowerCase()}`,
                description: `${format.name} format specifically for ${country.name} market`,
                formats: [format.id],
                countries: [market],
                delivery_type: 'guaranteed',
                cpm: format.type === 'video' ? 25.0 : 15.0
            });
        });
    });

    displayProductSuggestions();
}

function displayProductSuggestions() {
    const suggestionsHtml = suggestedProducts.map((product, index) => `
        <div class="product-suggestion" data-index="${index}">
            <div class="suggestion-header">
                <div>
                    <input type="checkbox" id="product-${index}" checked>
                    <label for="product-${index}">
                        <strong>${product.name}</strong>
                        <span class="badge">${product.type.replace('_', ' ')}</span>
                    </label>
                    <p>${product.description}</p>
                </div>
                <div class="pricing-controls">
                    <div class="pricing-type-toggle">
                        <label>
                            <input type="radio" name="pricing-type-${index}" value="fixed" ${product.cpm ? 'checked' : ''} onchange="togglePricingInputs(${index})">
                            Fixed
                        </label>
                        <label>
                            <input type="radio" name="pricing-type-${index}" value="auction" ${!product.cpm ? 'checked' : ''} onchange="togglePricingInputs(${index})">
                            Auction
                        </label>
                    </div>
                    <div class="pricing-inputs" id="pricing-inputs-${index}">
                        ${product.cpm ?
                            `<input type="number" id="cpm-${index}" placeholder="CPM" value="${product.cpm}" step="0.01" min="0">
                             <span>CPM</span>` :
                            `<input type="number" id="min-cpm-${index}" placeholder="Min" value="${product.price_guidance?.min || ''}" step="0.01" min="0">
                             <span>-</span>
                             <input type="number" id="max-cpm-${index}" placeholder="Max" value="${product.price_guidance?.max || ''}" step="0.01" min="0">
                             <span>CPM</span>`
                        }
                    </div>
                </div>
            </div>
            <div class="suggestion-details">
                <div>
                    <strong>Formats:</strong> ${product.formats.join(', ')}
                </div>
                <div>
                    <strong>Markets:</strong> ${product.countries.join(', ')}
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('product-suggestions').innerHTML = suggestionsHtml;
}

function selectAll() {
    document.querySelectorAll('.product-suggestion input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAll() {
    document.querySelectorAll('.product-suggestion input[type="checkbox"]').forEach(cb => cb.checked = false);
}

async function createSelectedProducts() {
    const selectedIndices = Array.from(document.querySelectorAll('.product-suggestion input[type="checkbox"]:checked'))
        .map(cb => parseInt(cb.id.replace('product-', '')));

    const productsToCreate = selectedIndices.map(i => {
        const product = {...suggestedProducts[i]};
        const pricingType = document.querySelector(`input[name="pricing-type-${i}"]:checked`).value;

        if (pricingType === 'fixed') {
            const cpm = document.getElementById(`cpm-${i}`).value;
            if (cpm) {
                product.cpm = parseFloat(cpm);
                delete product.price_guidance;
            }
        } else {
            const minCpm = document.getElementById(`min-cpm-${i}`).value;
            const maxCpm = document.getElementById(`max-cpm-${i}`).value;
            if (minCpm && maxCpm) {
                product.price_guidance = {
                    min: parseFloat(minCpm),
                    max: parseFloat(maxCpm)
                };
                delete product.cpm;
            }
        }
        return product;
    });

    if (productsToCreate.length === 0) {
        alert('Please select at least one product to create');
        return;
    }

    nextStep(); // Move to creation step

    document.getElementById('creation-progress').innerHTML =
        `<p>Creating ${productsToCreate.length} products...</p><div class="spinner"></div>`;

    try {
        const response = await fetch(`{{ url_for('products.create_bulk', tenant_id=tenant_id) }}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({products: productsToCreate})
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('created-count').textContent = result.created_count;
            document.getElementById('creation-progress').style.display = 'none';
            document.getElementById('creation-results').style.display = 'block';
        } else {
            alert('Error creating products: ' + result.error);
        }

    } catch (error) {
        alert('Error creating products: ' + error.message);
    }
}

function addSelectedCountry() {
    const select = document.getElementById('country-select');
    const selectedCode = select.value;

    if (!selectedCode) {
        alert('Please select a country');
        return;
    }

    // Check if already added
    const existingCheckbox = document.querySelector(`input[name="markets"][value="${selectedCode}"]`);
    if (existingCheckbox) {
        alert('This country has already been added');
        return;
    }

    const country = countries.find(c => c.code === selectedCode);
    const container = document.querySelector('.market-options');
    const newOption = document.createElement('label');
    newOption.className = 'market-option';
    newOption.innerHTML = `
        <input type="checkbox" name="markets" value="${country.code}" checked>
        <span class="market-name">${country.flag} ${country.name}</span>
    `;
    container.appendChild(newOption);

    // Reset select
    select.value = '';
}

function startOver() {
    window.location.reload();
}

function togglePricingInputs(index) {
    const pricingType = document.querySelector(`input[name="pricing-type-${index}"]:checked`).value;
    const pricingInputsDiv = document.getElementById(`pricing-inputs-${index}`);

    if (pricingType === 'fixed') {
        pricingInputsDiv.innerHTML = `
            <input type="number" id="cpm-${index}" placeholder="CPM" step="0.01" min="0">
            <span>CPM</span>
        `;
    } else {
        pricingInputsDiv.innerHTML = `
            <input type="number" id="min-cpm-${index}" placeholder="Min" step="0.01" min="0">
            <span>-</span>
            <input type="number" id="max-cpm-${index}" placeholder="Max" step="0.01" min="0">
            <span>CPM</span>
        `;
    }
}

// Initialize page and check inventory sync status
document.addEventListener('DOMContentLoaded', async function() {
    // First, check if inventory has been synced
    try {
        const response = await fetch(`{{ url_for('inventory.check_inventory_sync', tenant_id=tenant_id) }}`);
        const data = await response.json();

        if (!data.has_inventory) {
            // No inventory synced - show warning and hide wizard
            document.getElementById('inventory-check').style.display = 'block';
            document.getElementById('wizard-content').style.display = 'none';
            return; // Don't proceed with wizard initialization
        }

        // Inventory exists - proceed with wizard
        console.log(`Inventory synced: ${data.inventory_count} items, last sync: ${data.last_sync}`);

    } catch (error) {
        console.error('Error checking inventory sync status:', error);
        // Continue anyway in case of error
    }

    // Initialize country dropdown
    const select = document.getElementById('country-select');
    const alreadyShownCodes = ['US', 'CA', 'GB', 'AU', 'DE', 'FR', 'JP', 'BR'];

    // Filter out countries that are already shown as top markets
    const availableCountries = countries.filter(c => !alreadyShownCodes.includes(c.code));

    // Sort countries by name
    availableCountries.sort((a, b) => a.name.localeCompare(b.name));

    // Populate dropdown
    availableCountries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = `${country.flag} ${country.name}`;
        select.appendChild(option);
    });
});
</script>
{% endblock %}
