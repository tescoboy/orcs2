{% extends "base.html" %}

{% block title %}Inventory Browser - {{ tenant.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>GAM Inventory Browser</h2>
            <p class="text-muted">Browse and manage Google Ad Manager inventory for {{ tenant.name }}</p>
        </div>
    </div>

    <!-- Sync Status -->
    <div class="row mt-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Inventory Status</h5>
                            <p class="mb-0" id="syncStatus">Loading...</p>
                        </div>
                        <button class="btn btn-primary" onclick="syncInventory()" id="syncBtn">
                            <i class="bi bi-arrow-clockwise"></i> Sync Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Stats</h5>
                    <div id="inventoryStats">
                        <div class="text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Explanation -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">Understanding Inventory Types</h6>
                <ul class="mb-0">
                    <li><strong>Ad Units</strong> - The actual ad slots where ads are displayed (e.g., homepage banner, article sidebar)</li>
                    <li><strong>Placements</strong> - Groups of ad units that can be targeted together</li>
                    <li><strong>Custom Targeting</strong> - Key-value pairs for precise ad targeting (e.g., content_type=sports, user_segment=premium)</li>
                    <li><strong>Labels</strong> - Tags for organizing and categorizing inventory</li>
                </ul>
                <small class="d-block mt-2">The "All Inventory" view shows everything, while "Ad Units" filters to just the ad slots.</small>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Search Inventory</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchQuery"
                                   placeholder="Search by name or path...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="inventoryType">
                                <option value="">All Types</option>
                                <option value="ad_unit">Ad Units</option>
                                <option value="placement">Placements</option>
                                <option value="label">Labels</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="inventoryStatus">
                                <option value="">All Status</option>
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                                <option value="ARCHIVED">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="searchInventory()">
                                Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row mt-4">
        <!-- Tree View -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ad Unit Hierarchy</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="adUnitTree" class="tree-view">
                        <div class="text-muted">Loading ad unit tree...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Inventory Details</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="inventoryDetail">
                        <p class="text-muted">Select an inventory item to view details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="row mt-4" id="searchResults" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Search Results</h5>
                </div>
                <div class="card-body">
                    <div id="searchResultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Assignment Modal -->
<div class="modal fade" id="assignProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign to Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProductAssignment()">
                    Save Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.tree-view {
    font-family: monospace;
}

.tree-node {
    margin-left: 20px;
    cursor: pointer;
    user-select: none;
}

.tree-node:hover {
    background-color: #f0f0f0;
}

.tree-node.selected {
    background-color: #e3f2fd;
}

.tree-toggle {
    display: inline-block;
    width: 20px;
    text-align: center;
}

.node-icon {
    margin-right: 5px;
}

.node-status {
    font-size: 0.8em;
    margin-left: 10px;
}

.node-status.active { color: #28a745; }
.node-status.inactive { color: #6c757d; }
.node-status.archived { color: #dc3545; }

.inventory-size {
    display: inline-block;
    padding: 2px 8px;
    margin: 2px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    font-size: 0.85em;
}

.search-result-item {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}
</style>

<script>
const tenantId = '{{ tenant.tenant_id }}';
let selectedInventory = null;
let inventoryTree = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check for URL parameters to pre-filter
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type');
    if (typeParam) {
        document.getElementById('inventoryType').value = typeParam;
    }

    loadInventoryStatus();

    // If type is specified, do initial search
    if (typeParam) {
        searchInventory();
    }
});

function loadInventoryStatus() {
    fetch(`/api/tenant/${tenantId}/inventory/tree`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            const syncStatus = document.getElementById('syncStatus');
            const stats = document.getElementById('inventoryStats');

            if (data.last_sync) {
                const lastSync = new Date(data.last_sync);
                const now = new Date();
                const diffMs = now - lastSync;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                let timeAgo;
                if (diffDays > 0) {
                    timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else if (diffHours > 0) {
                    timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else if (diffMins > 0) {
                    timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                } else {
                    timeAgo = 'just now';
                }

                syncStatus.innerHTML = `
                    Last synced: ${lastSync.toLocaleString()}
                    <span class="text-muted">(${timeAgo})</span>
                    ${data.needs_refresh ? '<span class="badge bg-warning ms-2">Needs Refresh</span>' : ''}
                `;
            } else {
                syncStatus.innerHTML = '<span class="text-warning">Never synced</span>';
            }

            stats.innerHTML = `
                <div><strong>Total Ad Units:</strong> ${data.total_units || 0}</div>
                <div><strong>Root Units:</strong> ${data.root_units ? data.root_units.length : 0}</div>
            `;

            inventoryTree = data;
            renderAdUnitTree(data.root_units || []);
        })
        .catch(error => {
            console.error('Error loading inventory status:', error);
            document.getElementById('syncStatus').innerHTML =
                '<span class="text-danger">Error loading status</span>';
        });
}

function syncInventory() {
    const btn = document.getElementById('syncBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

    fetch(`/api/tenant/${tenantId}/inventory/sync`, {
        method: 'POST',
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            alert(`Sync completed!\n\nAd Units: ${data.ad_units.total}\n` +
                  `Placements: ${data.placements.total}\nLabels: ${data.labels.total}`);

            // Reload the page to show new data
            window.location.reload();
        })
        .catch(error => {
            alert('Sync failed: ' + error.message);
            console.error('Sync error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sync Now';
        });
}

function renderAdUnitTree(units, container = null) {
    if (!container) {
        container = document.getElementById('adUnitTree');
        container.innerHTML = '';
    }

    if (units.length === 0) {
        container.innerHTML = '<p class="text-muted">No ad units found</p>';
        return;
    }

    units.forEach(unit => {
        const node = createTreeNode(unit);
        container.appendChild(node);
    });
}

function createTreeNode(unit) {
    const div = document.createElement('div');
    div.className = 'tree-node';
    div.dataset.unitId = unit.id;

    const hasChildren = unit.children && unit.children.length > 0;

    div.innerHTML = `
        <span class="tree-toggle" onclick="toggleNode(this, event)">
            ${hasChildren ? '▼' : '&nbsp;'}
        </span>
        <span class="node-icon">📁</span>
        <span class="node-name" onclick="selectNode('${unit.id}', event)">
            ${unit.name}
        </span>
        <span class="node-status ${unit.status.toLowerCase()}">[${unit.status}]</span>
    `;

    if (hasChildren) {
        const childContainer = document.createElement('div');
        childContainer.className = 'tree-children';
        childContainer.style.display = 'block';
        renderAdUnitTree(unit.children, childContainer);
        div.appendChild(childContainer);
    }

    return div;
}

function toggleNode(toggle, event) {
    event.stopPropagation();
    const node = toggle.parentElement;
    const children = node.querySelector('.tree-children');

    if (children) {
        if (children.style.display === 'none') {
            children.style.display = 'block';
            toggle.textContent = '▼';
        } else {
            children.style.display = 'none';
            toggle.textContent = '▶';
        }
    }
}

function selectNode(unitId, event) {
    event.stopPropagation();

    // Update selection
    document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
    event.target.closest('.tree-node').classList.add('selected');

    // Find unit data
    const unit = findUnitById(inventoryTree.root_units, unitId);
    if (unit) {
        showInventoryDetail(unit, 'ad_unit');
    }
}

function findUnitById(units, unitId) {
    for (const unit of units) {
        if (unit.id === unitId) return unit;
        if (unit.children) {
            const found = findUnitById(unit.children, unitId);
            if (found) return found;
        }
    }
    return null;
}

function showInventoryDetail(item, type) {
    selectedInventory = { item, type };

    const detail = document.getElementById('inventoryDetail');

    let html = `
        <h6>${item.name}</h6>
        <table class="table table-sm">
            <tr><th>ID:</th><td>${item.id}</td></tr>
            <tr><th>Type:</th><td>${type}</td></tr>
            <tr><th>Status:</th><td><span class="badge bg-${getStatusColor(item.status)}">${item.status}</span></td></tr>
    `;

    if (item.path && item.path.length > 0) {
        html += `<tr><th>Path:</th><td>${item.path.join(' > ')}</td></tr>`;
    }

    if (item.metadata) {
        if (item.metadata.sizes && item.metadata.sizes.length > 0) {
            html += '<tr><th>Sizes:</th><td>';
            item.metadata.sizes.forEach(size => {
                html += `<span class="inventory-size">${size.width}x${size.height}</span>`;
            });
            html += '</td></tr>';
        }

        if (item.metadata.ad_unit_code) {
            html += `<tr><th>Ad Unit Code:</th><td><code>${item.metadata.ad_unit_code}</code></td></tr>`;
        }

        if (item.metadata.explicitly_targeted) {
            html += `<tr><th>Targeting:</th><td>Explicitly Targeted</td></tr>`;
        }
    }

    html += '</table>';

    html += `
        <div class="mt-3">
            <button class="btn btn-sm btn-primary" onclick="assignToProduct()">
                Assign to Product
            </button>
            <button class="btn btn-sm btn-secondary" onclick="copyInventoryId('${item.id}')">
                Copy ID
            </button>
        </div>
    `;

    detail.innerHTML = html;
}

function getStatusColor(status) {
    switch (status) {
        case 'ACTIVE': return 'success';
        case 'INACTIVE': return 'secondary';
        case 'ARCHIVED': return 'danger';
        default: return 'info';
    }
}

function searchInventory() {
    const query = document.getElementById('searchQuery').value;
    const type = document.getElementById('inventoryType').value;
    const status = document.getElementById('inventoryStatus').value;

    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (type) params.append('type', type);
    if (status) params.append('status', status);

    fetch(`/api/tenant/${tenantId}/inventory/search?${params}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            showSearchResults(data.results);
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Search failed: ' + error.message);
        });
}

function showSearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    const content = document.getElementById('searchResultsContent');

    if (results.length === 0) {
        content.innerHTML = '<p class="text-muted">No results found</p>';
    } else {
        let html = `<p>Found ${results.length} items</p>`;
        html += '<div class="list-group">';

        results.forEach(item => {
            html += `
                <div class="list-group-item search-result-item"
                     onclick="showInventoryDetail(${JSON.stringify(item).replace(/"/g, '&quot;')}, '${item.type}')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${item.name}</h6>
                            <p class="mb-1 text-muted">${item.path ? item.path.join(' > ') : ''}</p>
                            <small>Type: ${item.type} | Status: ${item.status}</small>
                        </div>
                        <div>
                            <span class="badge bg-${getStatusColor(item.status)}">${item.status}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;
    }

    resultsDiv.style.display = 'block';
}

function assignToProduct() {
    if (!selectedInventory) return;

    // Load products
    fetch(`/api/tenant/${tenantId}/products`)
        .then(response => response.json())
        .then(data => {
            const productList = document.getElementById('productList');
            let html = '<div class="list-group">';

            data.products.forEach(product => {
                html += `
                    <label class="list-group-item">
                        <input class="form-check-input me-1" type="radio"
                               name="productSelection" value="${product.product_id}">
                        <strong>${product.name}</strong>
                        <small class="text-muted d-block">${product.description || 'No description'}</small>
                    </label>
                `;
            });

            html += '</div>';
            productList.innerHTML = html;

            new bootstrap.Modal(document.getElementById('assignProductModal')).show();
        })
        .catch(error => {
            console.error('Error loading products:', error);
            alert('Failed to load products');
        });
}

function saveProductAssignment() {
    const selectedProduct = document.querySelector('input[name="productSelection"]:checked');
    if (!selectedProduct || !selectedInventory) return;

    const productId = selectedProduct.value;

    // For now, just alert - in production, this would update the product configuration
    alert(`Would assign ${selectedInventory.item.name} to product ${productId}`);

    bootstrap.Modal.getInstance(document.getElementById('assignProductModal')).hide();
}

function copyInventoryId(id) {
    navigator.clipboard.writeText(id).then(() => {
        alert('Inventory ID copied to clipboard!');
    });
}

// Add enter key support for search
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchInventory();
        }
    });
});
</script>
{% endblock %}
