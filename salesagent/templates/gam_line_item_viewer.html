{% extends "base.html" %}

{% block title %}GAM Line Item Viewer - {{ tenant['name'] }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<style>
    /* Custom styles for line item viewer */
    /* Override base.html's tab-content display:none */
    .tab-content {
        display: block !important;
        margin-top: 1rem;
    }

    /* Ensure proper Bootstrap tab behavior */
    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .tab-pane.show {
        display: block;
    }
</style>

<div class="container-fluid">
    <h1 class="mb-4">GAM Line Item Viewer</h1>

    <!-- Line Item ID Input -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">View Line Item</h5>
            <div class="input-group">
                <input type="text" id="lineItemId" class="form-control" placeholder="Enter Line Item ID" value="{{ line_item_id }}">
                <button class="btn btn-primary" onclick="loadLineItem()">Load Line Item</button>
            </div>
            <small class="text-muted">Line Item ID: {{ line_item_id }} | Tenant: {{ tenant_id }}</small>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="alert alert-info" style="display: none;">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Loading line item data from GAM...
    </div>

    <!-- Error display -->
    <div id="error" class="alert alert-danger" style="display: none;"></div>

    <!-- Line Item Data Display -->
    <div id="lineItemContent" style="display: none;">

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-3" id="lineItemTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="targeting-tab" data-bs-toggle="tab" data-bs-target="#targeting" type="button">Targeting</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="creatives-tab" data-bs-toggle="tab" data-bs-target="#creatives" type="button">Creatives</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="delivery-tab" data-bs-toggle="tab" data-bs-target="#delivery" type="button">Delivery Settings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button">Raw GAM Data</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="product-json-tab" data-bs-toggle="tab" data-bs-target="#product-json" type="button">Product JSON</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="lineItemTabContent">

            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">Basic Information</div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tbody id="basicInfo"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">Order Information</div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tbody id="orderInfo"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Pricing & Budget</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody id="pricingInfo"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Schedule</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody id="scheduleInfo"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Targeting Tab -->
            <div class="tab-pane fade" id="targeting" role="tabpanel">
                <div class="card">
                    <div class="card-header">Targeting Criteria</div>
                    <div class="card-body">
                        <div id="targetingContent"></div>
                    </div>
                </div>
            </div>

            <!-- Creatives Tab -->
            <div class="tab-pane fade" id="creatives" role="tabpanel">
                <div class="card">
                    <div class="card-header">Associated Creatives</div>
                    <div class="card-body">
                        <div id="creativesContent"></div>
                    </div>
                </div>
            </div>

            <!-- Delivery Settings Tab -->
            <div class="tab-pane fade" id="delivery" role="tabpanel">
                <div class="card">
                    <div class="card-header">Delivery Configuration</div>
                    <div class="card-body">
                        <div id="deliveryContent"></div>
                    </div>
                </div>
            </div>

            <!-- Raw GAM Data Tab -->
            <div class="tab-pane fade" id="raw" role="tabpanel">
                <div class="card">
                    <div class="card-header">Raw GAM Response</div>
                    <div class="card-body">
                        <pre id="rawData" class="bg-light p-3" style="max-height: 600px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>

            <!-- Product JSON Tab -->
            <div class="tab-pane fade" id="product-json" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        Internal Media Product JSON
                        <button class="btn btn-sm btn-secondary float-end" onclick="copyProductJson()">Copy JSON</button>
                    </div>
                    <div class="card-body">
                        <pre id="productJsonContent" class="bg-light p-3" style="max-height: 600px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('GAM Line Item Viewer script loaded');
let currentLineItemData = null;
let customTargetingMappings = null;

// HTML escaping function to prevent XSS
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return 'N/A';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Format number with thousand separators
function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    return Number(num).toLocaleString();
}

// Parse custom targeting tree structure into readable HTML
function parseCustomTargeting(customTargeting) {
    if (!customTargeting) return null;

    let html = '';

    function parseNode(node, depth = 0) {
        const indent = depth * 20;
        let nodeHtml = '';

        if (node.logicalOperator) {
            // This is a group node
            nodeHtml += `<div style="margin-left: ${indent}px; margin-bottom: 10px;">`;
            nodeHtml += `<span class="badge bg-primary">${escapeHtml(node.logicalOperator)}</span>`;

            if (node.children && node.children.length > 0) {
                nodeHtml += '<div class="mt-2">';
                node.children.forEach((child, index) => {
                    if (index > 0 && !child.logicalOperator) {
                        nodeHtml += `<div style="margin-left: ${indent + 20}px; margin-bottom: 5px;"><span class="text-muted">${escapeHtml(node.logicalOperator)}</span></div>`;
                    }
                    nodeHtml += parseNode(child, depth + 1);
                });
                nodeHtml += '</div>';
            }
            nodeHtml += '</div>';
        } else if (node.keyId !== undefined) {
            // This is a key-value node
            nodeHtml += `<div style="margin-left: ${indent}px; margin-bottom: 8px;" class="key-value-item">`;
            nodeHtml += '<div class="d-flex align-items-center">';

            // Key - try to get name from mappings
            const keyId = String(node.keyId);
            const keyInfo = customTargetingMappings?.keys?.[keyId];
            const keyDisplay = keyInfo ? `${keyInfo.name} (${keyInfo.displayName})` : `Key ID: ${keyId}`;
            nodeHtml += `<span class="badge bg-secondary me-2">${escapeHtml(keyDisplay)}</span>`;

            // Operator
            const operatorDisplay = node.operator === 'IS_NOT' ? 'IS NOT' : (node.operator || 'IS');
            nodeHtml += `<span class="badge bg-info me-2">${escapeHtml(operatorDisplay)}</span>`;

            // Values - try to get names from mappings
            if (node.valueIds && node.valueIds.length > 0) {
                const valueDisplays = node.valueIds.map(id => {
                    const valueId = String(id);
                    const valueInfo = customTargetingMappings?.values?.[valueId];
                    return valueInfo ? valueInfo.displayName || valueInfo.name : valueId;
                });
                nodeHtml += '<span class="badge bg-success">';
                nodeHtml += valueDisplays.map(v => escapeHtml(v)).join(', ');
                nodeHtml += '</span>';
            } else if (node.values && node.values.length > 0) {
                nodeHtml += '<span class="badge bg-success">Values: ';
                nodeHtml += node.values.map(v => escapeHtml(v.name || v)).join(', ');
                nodeHtml += '</span>';
            }

            nodeHtml += '</div>';
            nodeHtml += '</div>';
        }

        return nodeHtml;
    }

    // Start parsing from the root
    html = parseNode(customTargeting);

    return html || null;
}

// Load line item if ID is provided in URL
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');

    // Initialize Bootstrap tabs properly
    const triggerTabList = document.querySelectorAll('#lineItemTabs button[data-bs-toggle="tab"]');
    console.log('Found tabs:', triggerTabList.length);
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);

        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            tabTrigger.show();
        });
    });

    const lineItemId = document.getElementById('lineItemId').value;
    if (lineItemId) {
        // Add a small delay to ensure authentication is established
        setTimeout(() => {
            console.log('Auto-loading line item after delay...');
            loadLineItem();
        }, 500);
    }
});

async function fetchCustomTargetingMappings() {
    try {
        const response = await fetch('/api/tenant/{{ tenant_id }}/gam/custom-targeting-keys', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });

        if (response.ok) {
            customTargetingMappings = await response.json();
            console.log('Loaded custom targeting mappings:', customTargetingMappings);
        }
    } catch (error) {
        console.error('Failed to load custom targeting mappings:', error);
    }
}

async function loadLineItem() {
    console.log('loadLineItem function called');
    const lineItemId = document.getElementById('lineItemId').value.trim();
    console.log('Line Item ID to load:', lineItemId);

    if (!lineItemId) {
        showError('Please enter a Line Item ID');
        return;
    }

    // Update URL
    window.history.pushState({}, '', `/tenant/{{ tenant_id }}/gam/line-item/${lineItemId}`);

    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('lineItemContent').style.display = 'none';

    // Fetch custom targeting mappings if not already loaded
    if (!customTargetingMappings) {
        await fetchCustomTargetingMappings();
    }

    try {
        console.log('Fetching line item from API...');
        const response = await fetch(`/api/tenant/{{ tenant_id }}/gam/line-item/${lineItemId}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });

        console.log('API response status:', response.status);

        // Check if we got redirected to login (HTML response)
        const contentType = response.headers.get('content-type');
        console.log('Response content-type:', contentType);
        if (contentType && contentType.includes('text/html')) {
            // We got redirected to login, reload the page to go through auth
            console.log('Got HTML response, reloading for auth...');
            window.location.reload();
            return;
        }

        if (!response.ok) {
            let errorMsg = 'Failed to fetch line item';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                // Response wasn't JSON
                errorMsg = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMsg);
        }

        currentLineItemData = await response.json();
        console.log('Parsed JSON data:', currentLineItemData);
        console.log('About to call displayLineItemData...');
        displayLineItemData(currentLineItemData);

    } catch (error) {
        showError(`Error loading line item: ${error.message}`);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function displayLineItemData(data) {
    console.log('displayLineItemData called');

    if (!data || !data.line_item) {
        console.error('Invalid data: missing line_item');
        showError('Invalid data received from server');
        return;
    }

    console.log('Setting lineItemContent to visible...');
    document.getElementById('lineItemContent').style.display = 'block';

    try {
        // Display all sections
        console.log('Calling displayBasicInfo...');
        displayBasicInfo(data.line_item);

        console.log('Calling displayOrderInfo...');
        displayOrderInfo(data.order);

        console.log('Calling displayPricingInfo...');
        displayPricingInfo(data.line_item);

        console.log('Calling displayScheduleInfo...');
        displayScheduleInfo(data.line_item);

        console.log('Targeting data:', data.line_item.targeting);
        console.log('Inventory details:', data.inventory_details);
        if (data.line_item.targeting) {
            console.log('Calling displayTargeting...');
            displayTargeting(data.line_item.targeting, data.inventory_details);
        }

        console.log('Creatives data:', data.creatives);
        console.log('Creative associations:', data.creative_associations);
        console.log('Calling displayCreatives...');
        displayCreatives(data.creatives, data.creative_associations);

        console.log('Calling displayDeliverySettings...');
        displayDeliverySettings(data.line_item);

        // Display raw data
        document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

        // Display product JSON with human-readable targeting prominently
        if (data.media_product_json) {
            console.log('Media Product JSON with human-readable targeting:', data.media_product_json);

            // Highlight the key-value targeting if present
            if (data.media_product_json.implementation_config?.gam?.key_value_targeting) {
                console.log('Human-readable key-value targeting:',
                    data.media_product_json.implementation_config.gam.key_value_targeting);
            }

            document.getElementById('productJsonContent').textContent = JSON.stringify(data.media_product_json, null, 2);
        }
    } catch (error) {
        console.error('Error in displayLineItemData:', error);
        console.error('Error stack:', error.stack);
        showError('Error displaying data: ' + error.message);
    }
}

function displayBasicInfo(lineItem) {
    const tbody = document.getElementById('basicInfo');
    tbody.innerHTML = `
        <tr><td><strong>Line Item ID:</strong></td><td>${escapeHtml(lineItem.id)}</td></tr>
        <tr><td><strong>Name:</strong></td><td>${escapeHtml(lineItem.name)}</td></tr>
        <tr><td><strong>Type:</strong></td><td>${escapeHtml(lineItem.lineItemType)}</td></tr>
        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusBadgeClass(lineItem.status)}">${escapeHtml(lineItem.status)}</span></td></tr>
        <tr><td><strong>Priority:</strong></td><td>${escapeHtml(lineItem.priority)}</td></tr>
        <tr><td><strong>External ID:</strong></td><td>${escapeHtml(lineItem.externalId)}</td></tr>
    `;
}

function displayOrderInfo(order) {
    const tbody = document.getElementById('orderInfo');
    if (!order) {
        tbody.innerHTML = '<tr><td>Order information not available</td></tr>';
        return;
    }

    tbody.innerHTML = `
        <tr><td><strong>Order ID:</strong></td><td>${escapeHtml(order.id)}</td></tr>
        <tr><td><strong>Order Name:</strong></td><td>${escapeHtml(order.name)}</td></tr>
        <tr><td><strong>Advertiser:</strong></td><td>${escapeHtml(order.advertiserId)}</td></tr>
        <tr><td><strong>Trafficker:</strong></td><td>${escapeHtml(order.traffickerId)}</td></tr>
        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusBadgeClass(order.status)}">${escapeHtml(order.status)}</span></td></tr>
    `;
}

function displayPricingInfo(lineItem) {
    const tbody = document.getElementById('pricingInfo');
    let cpm = 0;
    if (lineItem.costPerUnit && lineItem.costPerUnit.microAmount) {
        cpm = lineItem.costPerUnit.microAmount / 1000000;
    }

    // Get delivery stats if available
    let impressionsDelivered = 0;
    let clicksDelivered = 0;
    if (lineItem.stats && lineItem.stats.impressionsDelivered) {
        impressionsDelivered = lineItem.stats.impressionsDelivered;
        clicksDelivered = lineItem.stats.clicksDelivered || 0;
    }

    // Calculate delivery percentage
    const goal = lineItem.unitsBought || 0;
    const deliveryPercentage = goal > 0 ? (impressionsDelivered / goal * 100).toFixed(1) : 0;

    tbody.innerHTML = `
        <tr><td><strong>Cost Type:</strong></td><td>${lineItem.costType}</td></tr>
        <tr><td><strong>CPM:</strong></td><td>$${cpm.toFixed(2)}</td></tr>
        <tr><td><strong>Units Bought (Goal):</strong></td><td>${goal.toLocaleString()}</td></tr>
        <tr><td><strong>Impressions Delivered:</strong></td><td>${impressionsDelivered.toLocaleString()} (${deliveryPercentage}%)</td></tr>
        <tr><td><strong>Clicks Delivered:</strong></td><td>${clicksDelivered.toLocaleString()}</td></tr>
        <tr><td><strong>Total Budget:</strong></td><td>$${((goal) * cpm / 1000).toFixed(2)}</td></tr>
        <tr><td><strong>Spent (Est.):</strong></td><td>$${((impressionsDelivered) * cpm / 1000).toFixed(2)}</td></tr>
        <tr><td><strong>Discount:</strong></td><td>${lineItem.discount || 0}%</td></tr>
        <tr><td><strong>Value Cost Per Unit:</strong></td><td>${lineItem.valueCostPerUnit ? `$${(lineItem.valueCostPerUnit.microAmount / 1000000).toFixed(2)}` : 'N/A'}</td></tr>
    `;
}

function displayScheduleInfo(lineItem) {
    const tbody = document.getElementById('scheduleInfo');

    function formatDateTime(dt) {
        if (!dt) return 'N/A';

        // Handle ISO string format (e.g., "2023-07-25T19:33:00")
        if (typeof dt === 'string') {
            const date = new Date(dt);
            if (!isNaN(date.getTime())) {
                return date.toLocaleString();
            }
            return dt; // Return as-is if not a valid date string
        }

        // Handle GAM object format with nested date/time
        if (dt.date) {
            return `${dt.date.year}-${String(dt.date.month).padStart(2, '0')}-${String(dt.date.day).padStart(2, '0')} ${String(dt.hour || 0).padStart(2, '0')}:${String(dt.minute || 0).padStart(2, '0')}`;
        }

        return 'N/A';
    }

    tbody.innerHTML = `
        <tr><td><strong>Start Date:</strong></td><td>${formatDateTime(lineItem.startDateTime)}</td></tr>
        <tr><td><strong>End Date:</strong></td><td>${formatDateTime(lineItem.endDateTime)}</td></tr>
        <tr><td><strong>Delivery Rate Type:</strong></td><td>${lineItem.deliveryRateType}</td></tr>
        <tr><td><strong>Creation Date:</strong></td><td>${formatDateTime(lineItem.creationDateTime)}</td></tr>
        <tr><td><strong>Last Modified:</strong></td><td>${formatDateTime(lineItem.lastModifiedDateTime)}</td></tr>
    `;
}

function displayTargeting(targeting, inventoryDetails) {
    const container = document.getElementById('targetingContent');
    console.log('displayTargeting called with:', targeting, inventoryDetails);

    if (!container) {
        console.error('targetingContent element not found!');
        return;
    }

    if (!targeting) {
        container.innerHTML = '<p>No targeting configured</p>';
        return;
    }

    let html = '<div class="row">';

    // Inventory targeting - MOVED TO TOP AND ENHANCED
    if (targeting.inventoryTargeting) {
        html += '<div class="col-md-12 mb-4">';
        html += '<div class="card">';
        html += '<div class="card-header bg-primary text-white">';
        html += '<h5 class="mb-0">Inventory Targeting (Ad Units & Placements)</h5>';
        html += '</div>';
        html += '<div class="card-body">';

        // Placements section
        if (targeting.inventoryTargeting.targetedPlacementIds && targeting.inventoryTargeting.targetedPlacementIds.length > 0) {
            html += '<div class="mb-3">';
            html += '<h6><i class="bi bi-folder2-open"></i> Targeted Placements</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-hover">';
            html += '<thead><tr><th>Placement Name</th><th>ID</th><th>Status</th><th>Ad Units in Placement</th></tr></thead>';
            html += '<tbody>';

            targeting.inventoryTargeting.targetedPlacementIds.forEach(placementId => {
                const placement = inventoryDetails?.placements?.[placementId];
                if (placement) {
                    html += '<tr>';
                    html += `<td><strong>${escapeHtml(placement.name)}</strong>`;
                    if (placement.description) {
                        html += `<br><small class="text-muted">${escapeHtml(placement.description)}</small>`;
                    }
                    html += '</td>';
                    html += `<td><code>${escapeHtml(placementId)}</code></td>`;
                    html += `<td><span class="badge bg-${placement.status === 'ACTIVE' ? 'success' : 'secondary'}">${escapeHtml(placement.status)}</span></td>`;
                    html += '<td>';
                    if (placement.targetedAdUnitIds && placement.targetedAdUnitIds.length > 0) {
                        html += `<small>${placement.targetedAdUnitIds.length} ad unit(s)</small>`;
                    } else {
                        html += '<small class="text-muted">No specific ad units</small>';
                    }
                    html += '</td>';
                    html += '</tr>';
                } else {
                    html += '<tr>';
                    html += `<td colspan="4">Placement ID: <code>${escapeHtml(placementId)}</code> <small class="text-muted">(Details not available)</small></td>`;
                    html += '</tr>';
                }
            });

            html += '</tbody></table>';
            html += '</div>';
            html += '</div>';
        }

        // Ad Units section with hierarchy
        if (targeting.inventoryTargeting.targetedAdUnits && targeting.inventoryTargeting.targetedAdUnits.length > 0) {
            html += '<div class="mb-3">';
            html += '<h6><i class="bi bi-diagram-3"></i> Targeted Ad Units</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-hover">';
            html += '<thead><tr><th>Ad Unit Hierarchy</th><th>ID</th><th>Code</th><th>Include Descendants</th><th>Status</th></tr></thead>';
            html += '<tbody>';

            targeting.inventoryTargeting.targetedAdUnits.forEach(targetedUnit => {
                const adUnit = inventoryDetails?.ad_units?.[targetedUnit.adUnitId];
                if (adUnit) {
                    html += '<tr>';
                    html += '<td>';
                    html += `<div class="d-flex align-items-center">`;
                    // Show hierarchy with indentation
                    const pathParts = adUnit.fullPath.split(' > ');
                    const indent = (pathParts.length - 1) * 20;
                    html += `<div style="margin-left: ${indent}px;">`;
                    html += `<i class="bi bi-folder me-1"></i>`;
                    html += `<strong>${escapeHtml(adUnit.name)}</strong>`;
                    if (pathParts.length > 1) {
                        html += `<br><small class="text-muted" style="margin-left: 20px;">Path: ${escapeHtml(adUnit.fullPath)}</small>`;
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';
                    html += `<td><code>${escapeHtml(targetedUnit.adUnitId)}</code></td>`;
                    html += `<td><code>${escapeHtml(adUnit.adUnitCode || 'N/A')}</code></td>`;
                    html += `<td>${targetedUnit.includeDescendants ? '<span class="badge bg-info">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>`;
                    html += `<td><span class="badge bg-${adUnit.status === 'ACTIVE' ? 'success' : 'secondary'}">${escapeHtml(adUnit.status)}</span></td>`;
                    html += '</tr>';
                } else {
                    html += '<tr>';
                    html += `<td colspan="5">Ad Unit ID: <code>${escapeHtml(targetedUnit.adUnitId)}</code> ${targetedUnit.includeDescendants ? '(+ descendants)' : ''} <small class="text-muted">(Details not available)</small></td>`;
                    html += '</tr>';
                }
            });

            html += '</tbody></table>';
            html += '</div>';
            html += '</div>';
        }

        // If neither placements nor ad units are targeted
        if ((!targeting.inventoryTargeting.targetedAdUnits || targeting.inventoryTargeting.targetedAdUnits.length === 0) &&
            (!targeting.inventoryTargeting.targetedPlacementIds || targeting.inventoryTargeting.targetedPlacementIds.length === 0)) {
            html += '<p class="text-muted">No specific inventory targeted (Run of Network)</p>';
        }

        html += '</div>'; // card-body
        html += '</div>'; // card
        html += '</div>'; // col-md-12
    }

    // Geographic targeting
    if (targeting.geoTargeting) {
        html += '<div class="col-md-6 mb-3">';
        html += '<h6>Geographic Targeting</h6>';
        html += '<ul class="list-unstyled">';

        if (targeting.geoTargeting.targetedLocations && targeting.geoTargeting.targetedLocations.length > 0) {
            html += '<li><strong>Included:</strong><ul>';
            targeting.geoTargeting.targetedLocations.forEach(loc => {
                html += `<li>${escapeHtml(loc.displayName || loc.id)} (${escapeHtml(loc.type)})</li>`;
            });
            html += '</ul></li>';
        }

        if (targeting.geoTargeting.excludedLocations && targeting.geoTargeting.excludedLocations.length > 0) {
            html += '<li><strong>Excluded:</strong><ul>';
            targeting.geoTargeting.excludedLocations.forEach(loc => {
                html += `<li>${escapeHtml(loc.displayName || loc.id)} (${escapeHtml(loc.type)})</li>`;
            });
            html += '</ul></li>';
        }

        html += '</ul></div>';
    }

    // Technology targeting
    if (targeting.technologyTargeting) {
        html += '<div class="col-md-6 mb-3">';
        html += '<h6>Technology Targeting</h6>';
        html += '<ul class="list-unstyled">';

        const tech = targeting.technologyTargeting;
        if (tech.deviceCategoryTargeting) {
            html += '<li><strong>Device Categories:</strong><ul>';
            (tech.deviceCategoryTargeting.targetedDeviceCategories || []).forEach(device => {
                html += `<li>${escapeHtml(device.name || device.id)}</li>`;
            });
            html += '</ul></li>';
        }

        if (tech.browserTargeting) {
            html += '<li><strong>Browsers:</strong><ul>';
            (tech.browserTargeting.browsers || []).forEach(browser => {
                html += `<li>${escapeHtml(browser.name || browser.id)}</li>`;
            });
            html += '</ul></li>';
        }

        html += '</ul></div>';
    }

    // Custom targeting (Key-Value Pairs)
    if (targeting.customTargeting) {
        html += '<div class="col-md-12 mb-3">';
        html += '<h6>Custom Targeting (Key-Value Pairs)</h6>';
        html += '<div class="card">';
        html += '<div class="card-body">';

        // Parse and display the custom targeting tree
        const customTargetingHtml = parseCustomTargeting(targeting.customTargeting);
        if (customTargetingHtml) {
            html += customTargetingHtml;
        } else {
            html += '<p class="text-muted">No key-value pairs configured</p>';
        }

        // Also show the raw structure in a collapsible section
        html += '<details class="mt-3">';
        html += '<summary class="text-muted" style="cursor: pointer;">View Raw Structure</summary>';
        html += '<pre class="bg-light p-2 mt-2" style="font-size: 0.85em;">' + JSON.stringify(targeting.customTargeting, null, 2) + '</pre>';
        html += '</details>';

        html += '</div>';
        html += '</div>';
        html += '</div>';
    }

    // Day part targeting
    if (targeting.dayPartTargeting) {
        html += '<div class="col-md-6 mb-3">';
        html += '<h6>Daypart Targeting</h6>';
        html += '<ul class="list-unstyled">';
        html += `<li><strong>Timezone:</strong> ${escapeHtml(targeting.dayPartTargeting.timeZone)}</li>`;

        if (targeting.dayPartTargeting.dayParts) {
            html += '<li><strong>Schedule:</strong><ul>';
            targeting.dayPartTargeting.dayParts.forEach(dp => {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                html += `<li>${escapeHtml(days[dp.dayOfWeek - 1])}: ${escapeHtml(dp.startTime.hour)}:00 - ${escapeHtml(dp.endTime.hour)}:00</li>`;
            });
            html += '</ul></li>';
        }

        html += '</ul></div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

function displayCreatives(creatives, associations) {
    const container = document.getElementById('creativesContent');
    console.log('displayCreatives called with:', creatives, associations);

    if (!container) {
        console.error('creativesContent element not found!');
        return;
    }

    if (!creatives || creatives.length === 0) {
        container.innerHTML = '<p>No creatives associated with this line item</p>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Creative ID</th><th>Name</th><th>Type</th><th>Size</th><th>Status</th></tr></thead><tbody>';

    creatives.forEach(creative => {
        const size = creative.size ? `${escapeHtml(creative.size.width)}x${escapeHtml(creative.size.height)}` : 'N/A';
        const previewLink = creative.previewUrl ?
            `<a href="${escapeHtml(creative.previewUrl)}" target="_blank">Preview</a>` : 'N/A';
        html += `<tr>`;
        html += `<td>${escapeHtml(creative.id)}</td>`;
        html += `<td>${escapeHtml(creative.name)}</td>`;
        html += `<td>${escapeHtml(creative['Creative.Type'] || 'Unknown')}</td>`;
        html += `<td>${size}</td>`;
        html += `<td>${previewLink}</td>`;
        html += `</tr>`;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function displayDeliverySettings(lineItem) {
    const container = document.getElementById('deliveryContent');
    console.log('displayDeliverySettings called with:', lineItem);

    if (!container) {
        console.error('deliveryContent element not found!');
        return;
    }

    let html = '<div class="row">';

    // Delivery settings
    html += '<div class="col-md-6">';
    html += '<h6>Delivery Configuration</h6>';
    html += '<ul class="list-unstyled">';
    html += `<li><strong>Delivery Rate Type:</strong> ${lineItem.deliveryRateType}</li>`;
    html += `<li><strong>Roadblocking Type:</strong> ${lineItem.roadblockingType || 'NONE'}</li>`;
    html += `<li><strong>Skip Inventory Check:</strong> ${lineItem.skipInventoryCheck ? 'Yes' : 'No'}</li>`;
    html += `<li><strong>Allow Overbook:</strong> ${lineItem.allowOverbook ? 'Yes' : 'No'}</li>`;
    html += `<li><strong>Reserve Inventory:</strong> ${lineItem.reserveAtCreation ? 'Yes' : 'No'}</li>`;
    html += '</ul>';
    html += '</div>';

    // Frequency caps
    if (lineItem.frequencyCaps && lineItem.frequencyCaps.length > 0) {
        html += '<div class="col-md-6">';
        html += '<h6>Frequency Caps</h6>';
        html += '<ul class="list-unstyled">';
        lineItem.frequencyCaps.forEach(cap => {
            html += `<li>${cap.maxImpressions} impressions per ${cap.numTimeUnits} ${cap.timeUnit}</li>`;
        });
        html += '</ul>';
        html += '</div>';
    }

    // Creative placeholders
    if (lineItem.creativePlaceholders && lineItem.creativePlaceholders.length > 0) {
        html += '<div class="col-md-12">';
        html += '<h6>Creative Placeholders</h6>';
        html += '<table class="table table-sm">';
        html += '<thead><tr><th>Size</th><th>Expected Count</th><th>Companions</th></tr></thead><tbody>';

        lineItem.creativePlaceholders.forEach(placeholder => {
            const size = placeholder.size ? `${placeholder.size.width}x${placeholder.size.height}` : 'Flexible';
            const companions = placeholder.companions ? placeholder.companions.map(c => `${c.size.width}x${c.size.height}`).join(', ') : 'None';
            html += `<tr>`;
            html += `<td>${size}</td>`;
            html += `<td>${placeholder.expectedCreativeCount || 1}</td>`;
            html += `<td>${companions}</td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        html += '</div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

function getStatusBadgeClass(status) {
    const statusMap = {
        'ACTIVE': 'success',
        'READY': 'info',
        'PAUSED': 'warning',
        'INACTIVE': 'secondary',
        'ARCHIVED': 'dark',
        'DRAFT': 'light',
        'DISAPPROVED': 'danger',
        'PENDING_APPROVAL': 'warning',
        'COMPLETED': 'primary',
        'CANCELED': 'danger'
    };
    return statusMap[status] || 'secondary';
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function copyProductJson() {
    const jsonText = document.getElementById('productJsonContent').textContent;
    navigator.clipboard.writeText(jsonText).then(() => {
        alert('Product JSON copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy JSON. Please select and copy manually.');
    });
}
</script>
{% endblock %}
