{% extends "base.html" %}

{% block title %}AI Product Creation - AdCP Admin{% endblock %}

{% block content %}
<div class="card">
    <h2>Create Product with AI Assistance</h2>

    <div class="alert alert-info">
        <strong>AI-Powered Configuration:</strong> Describe your product and let AI automatically configure placements, formats, and pricing based on your ad server inventory.
    </div>

    <div id="ai-form">
        <form id="product-description-form">
            <h3>Product Description</h3>

            <div class="form-group">
                <label for="name">Product Name *</label>
                <input type="text" id="name" name="name" required placeholder="e.g., Premium Homepage Takeover">
            </div>

            <div class="form-group">
                <label for="external_description">External Description *</label>
                <textarea id="external_description" name="external_description" rows="4" required
                    placeholder="Describe this product as buyers would see it. E.g., 'High-impact homepage placement with guaranteed viewability, targeting tech-savvy audiences across desktop and mobile devices.'"></textarea>
                <small style="color: #666;">This is what potential buyers will see</small>
            </div>

            <div class="form-group">
                <label for="internal_details">Internal Implementation Details</label>
                <textarea id="internal_details" name="internal_details" rows="4"
                    placeholder="Add any internal notes about implementation. E.g., 'Use homepage_top placement with 970x250 for desktop, fallback to 728x90. Exclude sensitive categories. Premium floor price $15 CPM.'"></textarea>
                <small style="color: #666;">Private notes to help AI understand technical requirements</small>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Analyze with AI</button>
                <a href="{{ url_for('products.list_products', tenant_id=tenant_id) }}" class="btn btn-secondary">Cancel</a>
                <a href="{{ url_for('products.add_product', tenant_id=tenant_id) }}" class="btn btn-secondary">Use Manual Form</a>
            </div>
        </form>
    </div>

    <div id="ai-results" style="display: none;">
        <h3>AI Configuration Results</h3>

        <div class="alert alert-success">
            AI has analyzed your product description and generated a configuration.
        </div>

        <div id="config-preview" style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
            <!-- Configuration preview will be inserted here -->
        </div>

        <form id="final-product-form" method="POST" action="{{ url_for('products.add_product', tenant_id=tenant_id) }}">
            <input type="hidden" id="final-config" name="ai_config">

            <h4>Review & Adjust</h4>

            <div class="form-group">
                <label for="final_name">Product Name</label>
                <input type="text" id="final_name" name="name" required>
            </div>

            <div class="form-group">
                <label for="final_description">Description</label>
                <textarea id="final_description" name="description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="final_product_id">Product ID</label>
                <input type="text" id="final_product_id" name="product_id">
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Create Product</button>
                <button type="button" class="btn btn-secondary" onclick="resetToDescriptionForm()">Start Over</button>
            </div>
        </form>
    </div>
</div>

<style>
.url-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.config-section {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.config-section h5 {
    margin-top: 0;
    color: #2c3e50;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
}

.format-chip {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
function resetToDescriptionForm() {
    document.getElementById('ai-form').style.display = 'block';
    document.getElementById('ai-results').style.display = 'none';
}

function displayConfiguration(config) {
    const preview = document.getElementById('config-preview');

    let html = '<div class="config-section">';

    // Formats
    html += '<h5>Creative Formats</h5>';
    html += '<div>';
    config.formats.forEach(format => {
        html += `<span class="format-chip">${format}</span>`;
    });
    html += '</div>';

    // Pricing
    html += '</div><div class="config-section">';
    html += '<h5>Pricing</h5>';
    if (config.delivery_type === 'guaranteed') {
        html += `<p>Guaranteed delivery at $${config.cpm} CPM</p>`;
    } else {
        html += `<p>Non-guaranteed with price guidance: $${config.price_guidance.min} - $${config.price_guidance.max} CPM</p>`;
    }

    // Targeting
    html += '</div><div class="config-section">';
    html += '<h5>Targeting</h5>';
    if (config.countries && config.countries.length > 0) {
        html += `<p><strong>Countries:</strong> ${config.countries.join(', ')}</p>`;
    }
    if (config.targeting_template) {
        const targeting = config.targeting_template;
        if (targeting.device_targets) {
            html += `<p><strong>Devices:</strong> ${targeting.device_targets.device_types.join(', ')}</p>`;
        }
        if (targeting.placement_targets) {
            html += `<p><strong>Placements:</strong> ${targeting.placement_targets.ad_unit_ids.join(', ')}</p>`;
        }
    }

    html += '</div>';
    preview.innerHTML = html;
}

document.getElementById('product-description-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = 'Analyzing... <span class="loading-spinner"></span>';
    submitButton.disabled = true;

    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        external_description: formData.get('external_description'),
        internal_details: formData.get('internal_details')
    };

    try {
        const response = await fetch(`{{ url_for('products.analyze_product_ai', tenant_id=tenant_id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();

            // Display results
            document.getElementById('ai-form').style.display = 'none';
            document.getElementById('ai-results').style.display = 'block';

            // Show configuration preview
            displayConfiguration(result.config);

            // Populate final form
            document.getElementById('final_name').value = data.name;
            document.getElementById('final_description').value = data.external_description;
            document.getElementById('final_product_id').value = result.config.product_id;
            document.getElementById('final-config').value = JSON.stringify(result.config);

        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to analyze product'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
});
</script>
{% endblock %}
