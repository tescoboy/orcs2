{% extends "base.html" %}

{% block title %}GAM Reporting - {{ tenant.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>GAM Reporting - {{ tenant.name }}</h1>

    <!-- Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="date-range">Date Range</label>
                    <select id="date-range" class="form-control" onchange="updateReports()">
                        <option value="today">Today (Hourly)</option>
                        <option value="this_month" selected>This Month (Daily)</option>
                        <option value="lifetime">Lifetime (Daily)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="timezone">Timezone</label>
                    <select id="timezone" class="form-control" onchange="updateReports()">
                        <option value="America/New_York">Eastern Time</option>
                        <option value="America/Chicago">Central Time</option>
                        <option value="America/Denver">Mountain Time</option>
                        <option value="America/Los_Angeles">Pacific Time</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="aggregation">Aggregate By</label>
                    <select id="aggregation" class="form-control" onchange="updateViews()">
                        <option value="advertiser">Advertiser</option>
                        <option value="country">Country</option>
                        <option value="ad_unit">Ad Unit</option>
                        <option value="order">Order</option>
                        <option value="line_item">Line Item</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary btn-block" onclick="exportData()">Export Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Impressions</h5>
                    <h2 id="total-impressions">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Spend</h5>
                    <h2 id="total-spend">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Average CPM</h5>
                    <h2 id="avg-cpm">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Countries</h5>
                    <h2 id="country-count">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for Different Views -->
    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" href="#table" role="tab">Table View</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" href="#chart" role="tab">Time Series</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap" href="#heatmap" role="tab">Country Heatmap</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="adunit-tab" data-bs-toggle="tab" data-bs-target="#adunit" href="#adunit" role="tab">Ad Unit Analysis</a>
        </li>
    </ul>

    <div class="tab-content" id="reportTabContent">
        <!-- Table View -->
        <div class="tab-pane fade show active" id="table" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div id="table-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading GAM reporting data...</p>
                    </div>
                    <div id="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="data-table">
                                <thead id="table-header"></thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Series Chart -->
        <div class="tab-pane fade" id="chart" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <canvas id="time-chart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Country Heatmap -->
        <div class="tab-pane fade" id="heatmap" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <!-- Filters for country tab -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="country-advertiser-filter" class="small">Filter by Advertiser</label>
                            <select id="country-advertiser-filter" class="form-control form-control-sm" onchange="updateCountryHeatmap()">
                                <option value="">All Advertisers</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="country-adunit-filter" class="small">Filter by Ad Unit</label>
                            <select id="country-adunit-filter" class="form-control form-control-sm" onchange="updateCountryHeatmap()">
                                <option value="">All Ad Units</option>
                            </select>
                        </div>
                    </div>

                    <h4>CPM by Country <small class="text-muted">(Circle size = Impressions)</small></h4>

                    <!-- Loading indicator -->
                    <div id="country-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading country data...</p>
                    </div>

                    <div id="world-map" style="height: 500px;"></div>
                    <div id="country-table" class="mt-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Impressions</th>
                                    <th>Spend</th>
                                    <th>CPM</th>
                                    <th>CTR</th>
                                </tr>
                            </thead>
                            <tbody id="country-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad Unit Analysis -->
        <div class="tab-pane fade" id="adunit" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <!-- Filters for ad unit tab -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="adunit-country-filter" class="small">Filter by Country</label>
                            <select id="adunit-country-filter" class="form-control form-control-sm" onchange="updateAdUnitAnalysis()">
                                <option value="">All Countries</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="adunit-advertiser-filter" class="small">Filter by Advertiser</label>
                            <select id="adunit-advertiser-filter" class="form-control form-control-sm" onchange="updateAdUnitAnalysis()">
                                <option value="">All Advertisers</option>
                            </select>
                        </div>
                    </div>

                    <h4>Performance by Ad Unit</h4>

                    <!-- Loading indicator -->
                    <div id="adunit-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading ad unit data...</p>
                    </div>

                    <canvas id="adunit-chart" style="max-height: 400px;"></canvas>
                    <div class="mt-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ad Unit</th>
                                    <th>Impressions</th>
                                    <th>Spend</th>
                                    <th>CPM</th>
                                    <th>Fill Rate</th>
                                </tr>
                            </thead>
                            <tbody id="adunit-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include required libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-choropleth@1.1.4/dist/choropleth.js"></script>

<script>
let currentData = null;
let timeChart = null;
let adUnitChart = null;
let worldMap = null;

function showLoadingIndicators() {
    // Show loading for table
    document.getElementById('table-loading').style.display = 'block';
    document.getElementById('table-container').style.display = 'none';

    // Show loading for charts
    const chartContainers = ['time-chart-container', 'heatmap-container', 'ad-unit-container'];
    chartContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = '<div class="text-center py-5 loading-indicator"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        }
    });
}

function hideLoadingIndicators() {
    // Hide table loading and force display the container
    const tableLoading = document.getElementById('table-loading');
    const tableContainer = document.getElementById('table-container');

    if (tableLoading) {
        tableLoading.style.display = 'none';
    }

    if (tableContainer) {
        // Force display with important to override any other styles
        tableContainer.style.cssText = 'display: block !important;';
    }
}

async function updateReports() {
    const dateRange = document.getElementById('date-range').value;
    const timezone = document.getElementById('timezone').value;

    // Show loading indicators for all tabs
    showLoadingIndicators();

    // Update loading message
    const loadingElements = document.querySelectorAll('.loading-indicator');
    loadingElements.forEach(el => {
        if (el.textContent) {
            el.textContent = 'Loading GAM data...';
        }
    });

    try {
        const response = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting?date_range=${dateRange}&timezone=${timezone}`, {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        currentData = result;

        console.log(`Loaded ${result.data.length} rows of data`);

        updateSummaryCards(result.data);
        updateViews();

    } catch (error) {
        console.error('Error fetching report:', error);
        alert('Failed to load report data. Please try again.');
    } finally {
        hideLoadingIndicators();
    }
}

function updateSummaryCards(data) {
    const totals = data.reduce((acc, row) => {
        acc.impressions += row.impressions || 0;
        acc.spend += row.spend || 0;
        acc.clicks += row.clicks || 0;
        // Countries not available in simplified data
        return acc;
    }, { impressions: 0, spend: 0, clicks: 0 });

    const avgCpm = totals.impressions > 0 ? (totals.spend / totals.impressions * 1000) : 0;

    document.getElementById('total-impressions').textContent = totals.impressions.toLocaleString();
    document.getElementById('total-spend').textContent = '$' + totals.spend.toFixed(2);
    document.getElementById('avg-cpm').textContent = '$' + avgCpm.toFixed(2);
    document.getElementById('country-count').textContent = 'N/A'; // Not available in simplified data

    // Populate filter dropdowns with unique values from data
    populateFiltersFromData(data);
}

function populateFiltersFromData(data) {
    // Extract unique advertisers
    const advertisers = new Map();
    const adUnits = new Map();
    const countries = new Set();

    data.forEach(row => {
        if (row.advertiser_id && row.advertiser_name) {
            advertisers.set(row.advertiser_id, row.advertiser_name);
        }
        if (row.ad_unit_id && row.ad_unit_name) {
            adUnits.set(row.ad_unit_id, row.ad_unit_name);
        }
        if (row.country) {
            countries.add(row.country);
        }
    });

    // Populate advertiser filters
    const advertiserFilters = ['country-advertiser-filter', 'adunit-advertiser-filter'];
    advertiserFilters.forEach(filterId => {
        const select = document.getElementById(filterId);
        if (select && select.options.length <= 1) { // Only populate if not already done
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Advertisers</option>';
            Array.from(advertisers.entries())
                .sort((a, b) => a[1].localeCompare(b[1]))
                .forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    select.appendChild(option);
                });
            select.value = currentValue;
        }
    });

    // Populate ad unit filter
    const adUnitFilter = document.getElementById('country-adunit-filter');
    if (adUnitFilter && adUnitFilter.options.length <= 1) {
        const currentValue = adUnitFilter.value;
        adUnitFilter.innerHTML = '<option value="">All Ad Units</option>';
        Array.from(adUnits.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                adUnitFilter.appendChild(option);
            });
        adUnitFilter.value = currentValue;
    }

    // Populate country filter
    const countryFilter = document.getElementById('adunit-country-filter');
    if (countryFilter && countryFilter.options.length <= 1) {
        const currentValue = countryFilter.value;
        countryFilter.innerHTML = '<option value="">All Countries</option>';
        Array.from(countries)
            .sort()
            .forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        countryFilter.value = currentValue;
    }
}

function updateViews() {
    if (!currentData) return;

    const aggregation = document.getElementById('aggregation').value;

    updateTableView(aggregation);
    updateTimeChart(aggregation);
    updateCountryHeatmap();
    updateAdUnitAnalysis();
}

function updateTableView(aggregation) {
    const data = aggregateData(currentData.data, aggregation);
    console.log(`Aggregated data for ${aggregation}:`, data.slice(0, 5)); // Debug first 5 rows

    const tableHeader = document.getElementById('table-header');
    const tableBody = document.getElementById('table-body');

    // Create header
    tableHeader.innerHTML = `
        <tr>
            <th>${aggregation.charAt(0).toUpperCase() + aggregation.slice(1).replace('_', ' ')}</th>
            <th>Impressions</th>
            <th>Clicks</th>
            <th>CTR</th>
            <th>Spend</th>
            <th>CPM</th>
        </tr>
    `;

    // Create rows
    tableBody.innerHTML = '';

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        // Display name based on available fields
        const displayName = row.line_item_name || row.order_name || row.advertiser_name || row.name || 'Unknown';
        tr.innerHTML = `
            <td>${displayName}</td>
            <td>${row.impressions.toLocaleString()}</td>
            <td>${row.clicks.toLocaleString()}</td>
            <td>${row.ctr.toFixed(2)}%</td>
            <td>$${row.spend.toFixed(2)}</td>
            <td>$${row.cpm.toFixed(2)}</td>
        `;
        tableBody.appendChild(tr);
    });

    console.log(`Added ${data.length} rows to table`);
}

function aggregateData(data, by) {
    const aggregated = {};

    // Debug: log first few rows to see what we have
    console.log('Sample data rows:', data.slice(0, 3));

    data.forEach(row => {
        let key, name;
        switch(by) {
            case 'advertiser':
                key = row.advertiser_id || 'Unknown';
                // Use advertiser name if available, otherwise show ID with prefix
                name = row.advertiser_name || `Advertiser ${key}`;
                break;
            case 'country':
                key = 'All'; // Country data not available in simplified report
                name = 'All Countries';
                break;
            case 'ad_unit':
                key = 'All'; // Ad unit data not available in simplified report
                name = 'All Ad Units';
                break;
            case 'order':
                key = row.order_id || 'Unknown';
                name = row.order_name || key;
                break;
            case 'line_item':
                key = row.line_item_id || 'Unknown';
                name = row.line_item_name || key;
                break;
            default:
                key = 'Unknown';
                name = 'Unknown';
        }

        if (!aggregated[key]) {
            aggregated[key] = {
                name: name,
                impressions: 0,
                clicks: 0,
                spend: 0,
                count: 0
            };
        } else if (name && name !== key && !name.startsWith('Advertiser ')) {
            // Update name if we get a real name (not just "Advertiser ID")
            aggregated[key].name = name;
        }

        aggregated[key].impressions += row.impressions || 0;
        aggregated[key].clicks += row.clicks || 0;
        aggregated[key].spend += row.spend || 0;
        aggregated[key].count += 1;
    });

    // Calculate derived metrics
    return Object.values(aggregated).map(item => ({
        ...item,
        ctr: item.impressions > 0 ? (item.clicks / item.impressions * 100) : 0,
        cpm: item.impressions > 0 ? (item.spend / item.impressions * 1000) : 0
    })).sort((a, b) => b.spend - a.spend);
}

function updateTimeChart(aggregation) {
    const ctx = document.getElementById('time-chart').getContext('2d');

    // Group data by date
    const timeData = {};
    currentData.data.forEach(row => {
        const date = row.timestamp.split('T')[0];
        if (!timeData[date]) {
            timeData[date] = { impressions: 0, spend: 0, clicks: 0 };
        }
        timeData[date].impressions += row.impressions || 0;
        timeData[date].spend += row.spend || 0;
        timeData[date].clicks += row.clicks || 0;
    });

    const labels = Object.keys(timeData).sort();
    const impressions = labels.map(date => timeData[date].impressions);
    const spend = labels.map(date => timeData[date].spend);

    if (timeChart) {
        timeChart.destroy();
    }

    timeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Impressions',
                data: impressions,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                yAxisID: 'y1',
            }, {
                label: 'Spend ($)',
                data: spend,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y2',
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Impressions'
                    }
                },
                y2: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Spend ($)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
}

async function updateCountryHeatmap() {
    const dateRange = document.getElementById('date-range').value;
    const timezone = document.getElementById('timezone').value;
    const advertiserId = document.getElementById('country-advertiser-filter').value;
    const adUnitId = document.getElementById('country-adunit-filter').value;

    // Show loading indicator
    document.getElementById('country-loading').style.display = 'block';
    document.getElementById('world-map').style.opacity = '0.5';

    try {
        // Build query params
        let params = `date_range=${dateRange}&timezone=${timezone}`;
        if (advertiserId) params += `&advertiser_id=${advertiserId}`;
        if (adUnitId) params += `&ad_unit_id=${adUnitId}`;

        // Fetch country breakdown data
        const response = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting/countries?${params}`, {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        const countries = result.data.countries || [];
        const advertiserNames = result.data.advertisers || {};
        const rawData = result.data.raw_data || [];

        // Update country count in summary card
        document.getElementById('country-count').textContent = result.data.total_countries || countries.length;

        // Populate filters with data
        populateCountryFilters(rawData, advertiserNames);

        // Update country table
        const tbody = document.getElementById('country-tbody');
        tbody.innerHTML = '';

        if (countries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No country data available</td></tr>';
        } else {
            countries.slice(0, 20).forEach(country => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${country.country || 'Unknown'}</td>
                    <td>${country.impressions.toLocaleString()}</td>
                    <td>$${country.spend.toFixed(2)}</td>
                    <td>$${country.avg_cpm.toFixed(2)}</td>
                    <td>${country.ctr.toFixed(2)}%</td>
                `;
            });
        }

        // Initialize or update map
        const mapContainer = document.getElementById('world-map');
        if (mapContainer && countries.length > 0) {
            // Destroy existing map if it exists
            if (worldMap) {
                worldMap.remove();
                worldMap = null;
            }

            // Wait for tab to be visible and container to have size
            setTimeout(() => {
                // Create new map
                worldMap = L.map('world-map').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(worldMap);

                // Force map to recalculate its size
                worldMap.invalidateSize();

                // Add markers for countries with data
                updateMapMarkers(worldMap, countries);
            }, 100);
        }

    } catch (error) {
        console.error('Error fetching country data:', error);
        const tbody = document.getElementById('country-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load country data</td></tr>';
    } finally {
        // Hide loading indicator
        document.getElementById('country-loading').style.display = 'none';
        document.getElementById('world-map').style.opacity = '1';
    }
}

function updateMapMarkers(map, countryData) {
    // Clear existing markers and legend
    map.eachLayer(layer => {
        if (layer instanceof L.CircleMarker) {
            map.removeLayer(layer);
        }
    });

    // Calculate min and max CPM from actual data
    const cpmValues = countryData.map(c => c.avg_cpm).filter(cpm => cpm > 0);
    if (cpmValues.length === 0) return;

    const minCPM = Math.min(...cpmValues);
    const maxCPM = Math.max(...cpmValues);

    // Calculate min and max impressions for proportional sizing
    const impressionValues = countryData.map(c => c.impressions).filter(imp => imp > 0);
    const minImpressions = Math.min(...impressionValues);
    const maxImpressions = Math.max(...impressionValues);
    const impressionRange = maxImpressions - minImpressions;

    // Add markers for top countries
    countryData.slice(0, 20).forEach(country => {
        const coords = getCountryCoordinates(country.country);
        if (coords) {
            // Scale radius based on actual data range (5-30 pixels)
            const normalizedImpressions = impressionRange > 0 ?
                (country.impressions - minImpressions) / impressionRange : 0.5;
            const radius = 5 + (normalizedImpressions * 25); // 5 to 30 pixels

            const marker = L.circleMarker(coords, {
                radius: radius,
                fillColor: getCPMColor(country.avg_cpm, minCPM, maxCPM),
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindPopup(`
                <strong>${country.country}</strong><br>
                Impressions: ${country.impressions.toLocaleString()}<br>
                CPM: $${country.avg_cpm.toFixed(2)}<br>
                Spend: $${country.spend.toFixed(2)}<br>
                CTR: ${country.ctr.toFixed(2)}%
            `);
        }
    });

    // Add legend showing CPM range
    addMapLegend(map, minCPM, maxCPM);
}

function getCPMColor(cpm, minCPM, maxCPM) {
    // Dynamic color scale from red (low CPM) to green (high CPM = good)
    // Normalize CPM to 0-1 range
    const range = maxCPM - minCPM;
    const normalized = range > 0 ? (cpm - minCPM) / range : 0.5;

    // Use a gradient from red through yellow to green (reversed for "green = good")
    if (normalized < 0.5) {
        // Red to Yellow (low to medium CPM)
        const intensity = normalized * 2;
        const r = 255;
        const g = Math.round(255 * intensity);
        const b = 0;
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Yellow to Green (medium to high CPM)
        const intensity = (normalized - 0.5) * 2;
        const r = Math.round(255 * (1 - intensity));
        const g = 255;
        const b = 0;
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function addMapLegend(map, minCPM, maxCPM) {
    // Remove existing legend if any
    if (map.legendControl) {
        map.removeControl(map.legendControl);
    }

    // Create custom legend control
    const legend = L.control({position: 'bottomright'});

    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'map-legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';

        const midCPM = (minCPM + maxCPM) / 2;

        div.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">CPM Range</div>
            <div style="display: flex; align-items: center; margin-bottom: 3px;">
                <div style="width: 20px; height: 10px; background: rgb(255, 0, 0); margin-right: 5px; border: 1px solid #ccc;"></div>
                <span>$${minCPM.toFixed(2)} (Low)</span>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 3px;">
                <div style="width: 20px; height: 10px; background: rgb(255, 255, 0); margin-right: 5px; border: 1px solid #ccc;"></div>
                <span>$${midCPM.toFixed(2)}</span>
            </div>
            <div style="display: flex; align-items: center;">
                <div style="width: 20px; height: 10px; background: rgb(0, 255, 0); margin-right: 5px; border: 1px solid #ccc;"></div>
                <span>$${maxCPM.toFixed(2)} (High)</span>
            </div>
        `;

        return div;
    };

    legend.addTo(map);
    map.legendControl = legend;
}

function getCountryCode(countryName) {
    // Simplified mapping - in production, use a complete mapping
    const mapping = {
        'United States': 'US',
        'Canada': 'CA',
        'United Kingdom': 'GB',
        'Germany': 'DE',
        'France': 'FR',
        'Japan': 'JP',
        'Australia': 'AU',
        'Brazil': 'BR',
        'India': 'IN',
        'Mexico': 'MX'
    };
    return mapping[countryName] || null;
}

function getCountryCoordinates(countryName) {
    // Expanded country coordinates mapping
    const coords = {
        'United States': [39.8283, -98.5795],
        'Canada': [56.1304, -106.3468],
        'United Kingdom': [55.3781, -3.4360],
        'Germany': [51.1657, 10.4515],
        'France': [46.2276, 2.2137],
        'Japan': [36.2048, 138.2529],
        'Australia': [-25.2744, 133.7751],
        'Brazil': [-14.2350, -51.9253],
        'India': [20.5937, 78.9629],
        'Mexico': [23.6345, -102.5528],
        'China': [35.8617, 104.1954],
        'Russia': [61.5240, 105.3188],
        'South Korea': [35.9078, 127.7669],
        'Italy': [41.8719, 12.5674],
        'Spain': [40.4637, -3.7492],
        'Netherlands': [52.1326, 5.2913],
        'Sweden': [60.1282, 18.6435],
        'Poland': [51.9194, 19.1451],
        'Argentina': [-38.4161, -63.6167],
        'South Africa': [-30.5595, 22.9375],
        'Turkey': [38.9637, 35.2433],
        'Indonesia': [-0.7893, 113.9213],
        'Thailand': [15.8700, 100.9925],
        'Philippines': [12.8797, 121.7740],
        'Vietnam': [14.0583, 108.2772],
        'Singapore': [1.3521, 103.8198],
        'Malaysia': [4.2105, 101.9758],
        'New Zealand': [-40.9006, 174.8860],
        'Ireland': [53.4129, -8.2439],
        'Belgium': [50.5039, 4.4699],
        'Switzerland': [46.8182, 8.2275],
        'Austria': [47.5162, 14.5501],
        'Norway': [60.4720, 8.4689],
        'Denmark': [56.2639, 9.5018],
        'Finland': [61.9241, 25.7482],
        'Portugal': [39.3999, -8.2245],
        'Greece': [39.0742, 21.8243],
        'Czech Republic': [49.8175, 15.4730],
        'Hungary': [47.1625, 19.5033],
        'Romania': [45.9432, 24.9668],
        'Israel': [31.0461, 34.8516],
        'United Arab Emirates': [23.4241, 53.8478],
        'Saudi Arabia': [23.8859, 45.0792],
        'Egypt': [26.8206, 30.8025],
        'Nigeria': [9.0820, 8.6753],
        'Kenya': [-0.0236, 37.9062],
        'Chile': [-35.6751, -71.5430],
        'Colombia': [4.5709, -74.2973],
        'Peru': [-9.1900, -75.0152],
        'Venezuela': [6.4238, -66.5897],
        'Pakistan': [30.3753, 69.3451],
        'Bangladesh': [23.6850, 90.3563],
        'Ukraine': [48.3794, 31.1656],
        'Taiwan': [23.6978, 120.9605],
        'Hong Kong': [22.3193, 114.1694]
    };
    return coords[countryName] || null;
}

async function updateAdUnitAnalysis() {
    const dateRange = document.getElementById('date-range').value;
    const timezone = document.getElementById('timezone').value;
    const country = document.getElementById('adunit-country-filter').value;
    const advertiserId = document.getElementById('adunit-advertiser-filter').value;

    // Show loading indicator
    document.getElementById('adunit-loading').style.display = 'block';
    const chartContainer = document.getElementById('adunit-chart');
    if (chartContainer) chartContainer.style.opacity = '0.5';

    try {
        // Build query params
        let params = `date_range=${dateRange}&timezone=${timezone}`;
        if (country) params += `&country=${encodeURIComponent(country)}`;
        if (advertiserId) params += `&advertiser_id=${advertiserId}`;

        // Fetch ad unit breakdown data
        const response = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting/ad-units?${params}`, {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        const adUnits = result.data.ad_units || [];
        const advertiserNames = result.data.advertisers || {};
        const countries = result.data.countries || [];
        const rawData = result.data.raw_data || [];

        // Populate filters with data
        populateAdUnitFilters(rawData, advertiserNames, countries);

        // Update ad unit table
        const tbody = document.getElementById('adunit-tbody');
        tbody.innerHTML = '';

        if (adUnits.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No ad unit data available</td></tr>';
        } else {
            // Show top 20 ad units
            adUnits.slice(0, 20).forEach(adUnit => {
                const fillRate = adUnit.impressions > 0 ? '100%' : '0%'; // Simplified fill rate
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td title="${adUnit.ad_unit_id}">${adUnit.ad_unit_name || adUnit.ad_unit_id || 'Unknown'}</td>
                    <td>${adUnit.impressions.toLocaleString()}</td>
                    <td>$${adUnit.spend.toFixed(2)}</td>
                    <td>$${adUnit.avg_cpm.toFixed(2)}</td>
                    <td>${fillRate}</td>
                `;
            });
        }

        // Update chart
        const chartContainer = document.getElementById('adunit-chart');
        if (chartContainer && adUnits.length > 0) {
            // Destroy existing chart if any
            if (adUnitChart) {
                adUnitChart.destroy();
            }

            // Create bar chart showing top 10 ad units by spend
            const topAdUnits = adUnits.slice(0, 10);
            adUnitChart = new Chart(chartContainer, {
                type: 'bar',
                data: {
                    labels: topAdUnits.map(au => {
                        const name = au.ad_unit_name || au.ad_unit_id || 'Unknown';
                        return name.length > 30 ? name.substring(0, 30) + '...' : name;
                    }),
                    datasets: [
                        {
                            label: 'Spend ($)',
                            data: topAdUnits.map(au => au.spend),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'CPM ($)',
                            data: topAdUnits.map(au => au.avg_cpm),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top Ad Units by Spend'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const adUnit = topAdUnits[context.dataIndex];
                                    const countries = Object.keys(adUnit.countries || {}).length;
                                    return `Countries: ${countries}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Spend ($)'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'CPM ($)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

    } catch (error) {
        console.error('Error fetching ad unit data:', error);
        const tbody = document.getElementById('adunit-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load ad unit data</td></tr>';
    } finally {
        // Hide loading indicator
        document.getElementById('adunit-loading').style.display = 'none';
        const chartContainer = document.getElementById('adunit-chart');
        if (chartContainer) chartContainer.style.opacity = '1';
    }
}

function exportData() {
    if (!currentData) return;

    const aggregation = document.getElementById('aggregation').value;
    const data = aggregateData(currentData.data, aggregation);

    // Convert to CSV
    const csv = [
        [aggregation, 'Impressions', 'Clicks', 'CTR', 'Spend', 'CPM'].join(','),
        ...data.map(row => [
            row.name,
            row.impressions,
            row.clicks,
            row.ctr.toFixed(2),
            row.spend.toFixed(2),
            row.cpm.toFixed(2)
        ].join(','))
    ].join('\n');

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `gam_report_${aggregation}_${new Date().toISOString()}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateReports();
    populateAllFilters();

    // Handle tab changes to reinitialize map when shown
    document.querySelectorAll('#reportTabs a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            if (e.target.id === 'heatmap-tab') {
                // Reinitialize map when heatmap tab is shown
                if (worldMap) {
                    setTimeout(() => {
                        worldMap.invalidateSize();
                    }, 100);
                }
            }
        });
    });
});

// Populate all filter dropdowns with available options
function populateCountryFilters(rawData, advertiserNames) {
    // Extract unique advertisers and ad units
    const advertisers = new Map();
    const adUnits = new Map();

    rawData.forEach(row => {
        if (row.advertiser_id) {
            const name = advertiserNames[row.advertiser_id] || `Advertiser ${row.advertiser_id}`;
            advertisers.set(row.advertiser_id, name);
        }
        if (row.ad_unit_id && row.ad_unit_name) {
            adUnits.set(row.ad_unit_id, row.ad_unit_name);
        }
    });

    // Populate advertiser filter
    const advertiserFilter = document.getElementById('country-advertiser-filter');
    if (advertiserFilter) {
        const currentValue = advertiserFilter.value;
        advertiserFilter.innerHTML = '<option value="">All Advertisers</option>';
        Array.from(advertisers.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                advertiserFilter.appendChild(option);
            });
        advertiserFilter.value = currentValue;
    }

    // Populate ad unit filter
    const adUnitFilter = document.getElementById('country-adunit-filter');
    if (adUnitFilter) {
        const currentValue = adUnitFilter.value;
        adUnitFilter.innerHTML = '<option value="">All Ad Units</option>';
        Array.from(adUnits.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                adUnitFilter.appendChild(option);
            });
        adUnitFilter.value = currentValue;
    }
}

function populateAdUnitFilters(rawData, advertiserNames, countries) {
    // Extract unique advertisers
    const advertisers = new Map();

    rawData.forEach(row => {
        if (row.advertiser_id) {
            const name = advertiserNames[row.advertiser_id] || `Advertiser ${row.advertiser_id}`;
            advertisers.set(row.advertiser_id, name);
        }
    });

    // Populate advertiser filter
    const advertiserFilter = document.getElementById('adunit-advertiser-filter');
    if (advertiserFilter) {
        const currentValue = advertiserFilter.value;
        advertiserFilter.innerHTML = '<option value="">All Advertisers</option>';
        Array.from(advertisers.entries())
            .sort((a, b) => a[1].localeCompare(b[1]))
            .forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                advertiserFilter.appendChild(option);
            });
        advertiserFilter.value = currentValue;
    }

    // Populate country filter
    const countryFilter = document.getElementById('adunit-country-filter');
    if (countryFilter) {
        const currentValue = countryFilter.value;
        countryFilter.innerHTML = '<option value="">All Countries</option>';
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
        });
        countryFilter.value = currentValue;
    }
}

async function populateAllFilters() {
    const dateRange = document.getElementById('date-range').value;
    const timezone = document.getElementById('timezone').value;

    try {
        // Fetch base report to get advertisers
        const baseResponse = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting?date_range=${dateRange}&timezone=${timezone}`, {
            credentials: 'same-origin'
        });

        if (baseResponse.ok) {
            const baseResult = await baseResponse.json();
            const data = baseResult.data || [];

            // Extract unique advertisers from base data
            const advertisers = new Map();
            data.forEach(row => {
                if (row.advertiser_id && row.advertiser_name) {
                    advertisers.set(row.advertiser_id, row.advertiser_name);
                }
            });

            // Populate advertiser filters
            const advertiserFilters = ['country-advertiser-filter', 'adunit-advertiser-filter'];
            advertiserFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    select.innerHTML = '<option value="">All Advertisers</option>';
                    Array.from(advertisers.entries())
                        .sort((a, b) => a[1].localeCompare(b[1]))
                        .forEach(([id, name]) => {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = name;
                            select.appendChild(option);
                        });
                }
            });
        }

        // Fetch country data to populate country filter
        const countryResponse = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting/countries?date_range=${dateRange}&timezone=${timezone}`, {
            credentials: 'same-origin'
        });

        if (countryResponse.ok) {
            const countryResult = await countryResponse.json();
            const countries = countryResult.data.countries || [];

            const countryFilter = document.getElementById('adunit-country-filter');
            if (countryFilter) {
                countryFilter.innerHTML = '<option value="">All Countries</option>';
                countries.forEach(country => {
                    if (country.country) {
                        const option = document.createElement('option');
                        option.value = country.country;
                        option.textContent = country.country;
                        countryFilter.appendChild(option);
                    }
                });
            }
        }

        // Fetch ad unit data to populate ad unit filter
        const adUnitResponse = await fetch(`/api/tenant/{{ tenant.tenant_id }}/gam/reporting/ad-units?date_range=${dateRange}&timezone=${timezone}`, {
            credentials: 'same-origin'
        });

        if (adUnitResponse.ok) {
            const adUnitResult = await adUnitResponse.json();
            const adUnits = adUnitResult.data.ad_units || [];

            const adUnitFilter = document.getElementById('country-adunit-filter');
            if (adUnitFilter) {
                adUnitFilter.innerHTML = '<option value="">All Ad Units</option>';
                adUnits.forEach(adUnit => {
                    if (adUnit.ad_unit_id && adUnit.ad_unit_name) {
                        const option = document.createElement('option');
                        option.value = adUnit.ad_unit_id;
                        option.textContent = adUnit.ad_unit_name || adUnit.ad_unit_id;
                        adUnitFilter.appendChild(option);
                    }
                });
            }
        }

    } catch (error) {
        console.error('Error populating filters:', error);
    }
}
</script>

<style>
/* Override base.html's tab-content hiding */
#reportTabContent {
    display: block !important;
}

#reportTabContent .tab-pane {
    display: none;
}

#reportTabContent .tab-pane.show.active {
    display: block !important;
}

.card {
    margin-bottom: 1rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

#world-map {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    border-bottom-color: #f8f9fa;
}
</style>
{% endblock %}
