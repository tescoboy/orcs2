{% extends "base.html" %}

{% block title %}{{ tenant.name }} - Settings{% endblock %}

{% block content %}
<style>
    .settings-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
        min-height: 600px;
    }

    .settings-nav {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.25rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        color: #4b5563;
        text-decoration: none;
    }

    .settings-nav-item:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .settings-nav-item.active {
        background: #eff6ff;
        color: #2563eb;
        font-weight: 600;
    }

    .settings-nav-icon {
        width: 20px;
        text-align: center;
    }

    .settings-nav-separator {
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
    }

    .settings-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .settings-section {
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .settings-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .settings-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .settings-header p {
        margin: 0;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    .checkbox-group label {
        margin: 0;
        font-size: 0.875rem;
        color: #374151;
    }

    .status-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-card.success {
        background: #f0fdf4;
        border-color: #86efac;
    }

    .status-card.warning {
        background: #fffbeb;
        border-color: #fde047;
    }

    .status-card.error {
        background: #fef2f2;
        border-color: #fca5a5;
    }

    .adapter-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .adapter-card {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .adapter-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .adapter-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .adapter-card.current {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .adapter-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .adapter-card p {
        margin: 0;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .adapter-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.125rem 0.5rem;
        background: #10b981;
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }

    .config-code {
        background: #1f2937;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.75rem;
        overflow-x: auto;
        position: relative;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: #374151;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .copy-button:hover {
        background: #4b5563;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    @media (max-width: 768px) {
        .settings-layout {
            grid-template-columns: 1fr;
        }

        .settings-nav {
            position: static;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 style="margin: 0; font-size: 1.875rem; font-weight: 700; color: #111827;">Settings</h1>
        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">
            Configure {{ tenant.name }}
        </p>
    </div>
    <a href="/tenant/{{ tenant.tenant_id }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="settings-layout">
    <!-- Settings Navigation -->
    <nav class="settings-nav">
        <a class="settings-nav-item active" data-section="general">
            <span class="settings-nav-icon">‚öôÔ∏è</span>
            <span>General</span>
        </a>

        <a class="settings-nav-item" data-section="adserver">
            <span class="settings-nav-icon">üñ•Ô∏è</span>
            <span>Ad Server</span>
        </a>

        <a class="settings-nav-item" data-section="products">
            <span class="settings-nav-icon">üì¶</span>
            <span>Products</span>
        </a>

        <a class="settings-nav-item" data-section="creatives">
            <span class="settings-nav-icon">üé®</span>
            <span>Creative Formats</span>
        </a>

        <a class="settings-nav-item" data-section="advertisers">
            <span class="settings-nav-icon">üë•</span>
            <span>Advertisers</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="integrations">
            <span class="settings-nav-icon">üîó</span>
            <span>Integrations</span>
        </a>

        <a class="settings-nav-item" data-section="api">
            <span class="settings-nav-icon">üîë</span>
            <span>API & Tokens</span>
        </a>

        <a class="settings-nav-item" data-section="ai">
            <span class="settings-nav-icon">ü§ñ</span>
            <span>AI Settings</span>
        </a>

        <a class="settings-nav-item" data-section="users">
            <span class="settings-nav-icon">üë§</span>
            <span>Users & Access</span>
        </a>

        <div class="settings-nav-separator"></div>

        <a class="settings-nav-item" data-section="advanced">
            <span class="settings-nav-icon">üîß</span>
            <span>Advanced</span>
        </a>
    </nav>

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- General Settings -->
        <div id="general" class="settings-section active">
            <div class="settings-header">
                <h2>General Settings</h2>
                <p>Basic configuration for your sales agent</p>
            </div>

            <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/general">
                <div class="form-section">
                    <h3>Organization Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tenant_name">Organization Name</label>
                            <input type="text" id="tenant_name" name="name" value="{{ tenant.name }}" required>
                        </div>

                        <div class="form-group">
                            <label for="subdomain">Subdomain</label>
                            <input type="text" id="subdomain" name="subdomain" value="{{ tenant.subdomain }}" readonly>
                            <small>Cannot be changed after creation</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Budget & Limits</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="max_daily_budget">Maximum Daily Budget</label>
                            <input type="number" id="max_daily_budget" name="max_daily_budget"
                                   value="{{ tenant.max_daily_budget }}" min="0" step="100">
                            <small>Maximum daily spend limit across all campaigns</small>
                        </div>

                        <!-- Min campaign budget field removed - not in model -->
                        <div class="form-group">
                            <label for="billing_plan">Billing Plan</label>
                            <input type="text" id="billing_plan" name="billing_plan"
                                   value="{{ tenant.billing_plan or 'standard' }}" readonly>
                            <small>Contact support to change billing plan</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Features</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable_aee_signals" name="enable_aee_signals"
                               {% if tenant.enable_aee_signals %}checked{% endif %}>
                        <label for="enable_aee_signals">Enable AEE Signals</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="human_review_required" name="human_review_required"
                               {% if tenant.human_review_required %}checked{% endif %}>
                        <label for="human_review_required">Require Human Review for Creatives</label>
                    </div>

                    <!-- Auto-approve trusted field removed - not in model -->
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>

        <!-- Ad Server Settings -->
        <div id="adserver" class="settings-section">
            <div class="settings-header">
                <h2>Ad Server Configuration</h2>
                <p>Connect and configure your ad serving platform</p>
            </div>

            {% if tenant.active_adapter %}
            <div class="status-card success">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>‚úÖ Connected to {{ tenant.active_adapter|title|replace('_', ' ') }}</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            Last synced: {{ last_sync_time or 'Never' }}
                        </p>
                    </div>
                    {% if tenant.active_adapter == 'google_ad_manager' %}
                    <button onclick="syncInventory()" class="btn btn-small">Sync Now</button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="status-card warning">
                <strong>‚ö†Ô∏è No Ad Server Connected</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Select an ad server below to get started
                </p>
            </div>
            {% endif %}

            <div class="form-section">
                <h3>Available Ad Servers</h3>
                <div class="adapter-cards">
                    <div class="adapter-card {% if tenant.active_adapter == 'mock' %}current{% endif %}"
                         onclick="selectAdapter('mock')">
                        {% if tenant.active_adapter == 'mock' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Mock (Testing)</h4>
                        <p>Perfect for development and testing. No external setup required.</p>
                    </div>

                    <div class="adapter-card {% if tenant.active_adapter == 'google_ad_manager' %}current{% endif %}"
                         onclick="selectAdapter('google_ad_manager')">
                        {% if tenant.active_adapter == 'google_ad_manager' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Google Ad Manager</h4>
                        <p>Enterprise ad serving platform from Google</p>
                    </div>

                    <div class="adapter-card {% if tenant.active_adapter == 'kevel' %}current{% endif %}"
                         onclick="selectAdapter('kevel')">
                        {% if tenant.active_adapter == 'kevel' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Kevel</h4>
                        <p>API-first ad serving for developers</p>
                    </div>

                    <div class="adapter-card {% if tenant.active_adapter == 'triton' %}current{% endif %}"
                         onclick="selectAdapter('triton')">
                        {% if tenant.active_adapter == 'triton' %}
                        <span class="adapter-badge">Current</span>
                        {% endif %}
                        <h4>Triton Digital</h4>
                        <p>Audio and podcast advertising platform</p>
                    </div>
                </div>
            </div>

            <!-- Adapter-specific configuration will be loaded here -->
            <div id="adapter-config">
                {% if tenant.active_adapter == 'google_ad_manager' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <h3>Google Ad Manager Configuration</h3>

                    <!-- OAuth Prerequisites Check -->
                    <div id="oauth-status" class="status-card" style="background: #f5f5f5; border-left: 4px solid #666; margin-bottom: 1rem;">
                        <h4>OAuth Setup Status</h4>
                        <p>Checking OAuth configuration...</p>
                    </div>

                    {% if adapter_config %}
                    <div class="status-card" style="background: #f0f9ff; border-left: 4px solid #0066cc;">
                        <h4>Current Configuration</h4>
                        <ul style="list-style: none; padding: 0; margin: 0.5rem 0;">
                            {% if adapter_config.get('network_code') %}
                            <li>‚úÖ Network Code: {{ adapter_config.get('network_code') }}</li>
                            {% else %}
                            <li>‚ùå Network Code: Not configured</li>
                            {% endif %}

                            {% if adapter_config.get('refresh_token') %}
                            <li>‚úÖ OAuth Refresh Token: Configured</li>
                            {% else %}
                            <li>‚ùå OAuth Refresh Token: Not configured</li>
                            {% endif %}

                            {% if adapter_config.get('application_name') %}
                            <li>‚úÖ Application Name: {{ adapter_config.get('application_name') }}</li>
                            {% else %}
                            <li>‚ÑπÔ∏è Application Name: Using default</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <strong>Not Configured</strong>
                        <p>Google Ad Manager adapter needs configuration. Please set up your GAM credentials below.</p>
                    </div>
                    {% endif %}

                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="gam_refresh_token">OAuth Refresh Token</label>
                        <input type="text" id="gam_refresh_token" class="form-control"
                               value="{{ adapter_config.get('refresh_token', '') if adapter_config else '' }}"
                               placeholder="Your OAuth refresh token">
                        <small class="form-text text-muted">Required for API access. Enter token and click "Auto-detect Network" to retrieve network code.</small>
                    </div>

                    <div class="form-group">
                        <label for="gam_network_code">Network Code</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="gam_network_code" class="form-control"
                                   value="{{ adapter_config.get('network_code', '') if adapter_config else '' }}"
                                   placeholder="Will be auto-detected" readonly>
                            <button onclick="detectGAMNetwork()" class="btn btn-secondary"
                                    id="detect-network-btn">Auto-detect Network</button>
                        </div>
                        <small class="form-text text-muted">Automatically retrieved from your GAM account</small>
                    </div>

                    <div class="form-group">
                        <label for="gam_trafficker_id">Trafficker User ID</label>
                        <input type="text" id="gam_trafficker_id" class="form-control"
                               value="{{ adapter_config.get('trafficker_id', '') if adapter_config else '' }}"
                               placeholder="Your GAM user ID (will be auto-detected)">
                        <small class="form-text text-muted">The GAM user ID who will create line items. Auto-detected when you click "Auto-detect Network" above.</small>
                    </div>

                    <div class="form-group">
                        <button onclick="saveGAMConfig()" class="btn btn-primary">Save GAM Configuration</button>
                        {% if adapter_config and adapter_config.get('refresh_token') %}
                        <button onclick="testGAMConnection()" class="btn btn-secondary" style="margin-left: 0.5rem;">Test Connection</button>
                        {% endif %}
                    </div>
                </div>
                {% elif tenant.active_adapter == 'mock' %}
                <div class="form-section" style="margin-top: 2rem;">
                    <div class="alert alert-info">
                        <strong>Mock Adapter Active</strong>
                        <p>The mock adapter is configured and ready for testing. No additional setup required.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Products Settings -->
        <div id="products" class="settings-section">
            <div class="settings-header">
                <h2>Product Management</h2>
                <p>Define advertising products available for purchase</p>
            </div>

            {% if product_count == 0 %}
            <!-- Show wizard prominently for new tenants -->
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                        <strong>No Products Configured Yet</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                            Get started quickly with our Product Setup Wizard to create your first advertising products.
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/products/setup-wizard" class="btn btn-success">
                        <i class="fas fa-magic"></i> Launch Setup Wizard
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ product_count }} Products Configured</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_products }} active, {{ draft_products }} draft
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/tenant/{{ tenant.tenant_id }}/products" class="btn btn-small">Manage</a>
                        <a href="/tenant/{{ tenant.tenant_id }}/products/setup-wizard" class="btn btn-success btn-small">
                            <i class="fas fa-magic"></i> Setup Wizard
                        </a>
                        <a href="/tenant/{{ tenant.tenant_id }}/products/add" class="btn btn-primary btn-small">Add New</a>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Product Templates</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Quick-start with industry-standard product templates
                </p>
                <div class="form-grid">
                    <button onclick="loadTemplate('display')" class="btn btn-secondary">
                        <i class="fas fa-desktop"></i> Display Advertising
                    </button>
                    <button onclick="loadTemplate('video')" class="btn btn-secondary">
                        <i class="fas fa-video"></i> Video Advertising
                    </button>
                    <button onclick="loadTemplate('audio')" class="btn btn-secondary">
                        <i class="fas fa-microphone"></i> Audio/Podcast
                    </button>
                    <button onclick="loadTemplate('native')" class="btn btn-secondary">
                        <i class="fas fa-newspaper"></i> Native Content
                    </button>
                </div>
            </div>
        </div>

        <!-- Creative Formats Settings -->
        <div id="creatives" class="settings-section">
            <div class="settings-header">
                <h2>Creative Formats</h2>
                <p>Manage accepted creative formats and auto-approval rules</p>
            </div>

            <div class="form-section">
                <h3>Auto-Approval Settings</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Select formats that can be automatically approved without human review
                </p>

                <div class="form-grid">
                    {% for format in creative_formats %}
                    <div class="checkbox-group">
                        <input type="checkbox" id="format_{{ format.id }}" name="auto_approve_{{ format.id }}"
                               {% if format.auto_approve %}checked{% endif %}>
                        <label for="format_{{ format.id }}">{{ format.name }} ({{ format.dimensions }})</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="button-group">
                <a href="/tenant/{{ tenant.tenant_id }}/creative-formats" class="btn btn-primary">
                    Manage Creative Formats
                </a>
            </div>
        </div>

        <!-- Advertisers Settings -->
        <div id="advertisers" class="settings-section">
            <div class="settings-header">
                <h2>Advertiser Management</h2>
                <p>Manage advertisers who can access your inventory</p>
            </div>

            <div class="status-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ advertiser_count }} Advertisers Registered</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                            {{ active_advertisers }} active this month
                        </p>
                    </div>
                    <a href="/tenant/{{ tenant.tenant_id }}/principals/create" class="btn btn-primary btn-small">
                        Add Advertiser
                    </a>
                </div>
            </div>

            <!-- List of advertisers would go here -->
        </div>

        <!-- Integrations Settings -->
        <div id="integrations" class="settings-section">
            <div class="settings-header">
                <h2>Integrations</h2>
                <p>Connect external services and configure webhooks</p>
            </div>

            <div class="form-section">
                <h3>Slack Integration</h3>
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/slack">
                    <div class="form-group">
                        <label for="slack_webhook_url">Task Notifications Webhook URL</label>
                        <input type="url" id="slack_webhook_url" name="slack_webhook_url"
                               value="{{ tenant.slack_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/WEBHOOK/URL">
                        <small>Receives notifications for new tasks and creative approvals</small>
                    </div>

                    <div class="form-group">
                        <label for="slack_audit_webhook_url">Audit Log Webhook URL (Optional)</label>
                        <input type="url" id="slack_audit_webhook_url" name="slack_audit_webhook_url"
                               value="{{ tenant.slack_audit_webhook_url or '' }}"
                               placeholder="https://hooks.slack.com/services/YOUR/AUDIT/WEBHOOK">
                        <small>Separate channel for audit logs and security alerts</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                        <button type="button" onclick="testSlack()" class="btn btn-secondary">Test Connection</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Settings -->
        <div id="api" class="settings-section">
            <div class="settings-header">
                <h2>API & Tokens</h2>
                <p>Manage API access and authentication tokens</p>
            </div>

            <div class="form-section">
                <h3>MCP Server Endpoint</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">{% if tenant.subdomain == 'localhost' %}http://localhost:8080/mcp/{% else %}http://{{ tenant.subdomain }}.localhost:8080/mcp/{% endif %}</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Python Client Example</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">from fastmcp.client import Client
from fastmcp.client.transports import StreamableHttpTransport

headers = {"x-adcp-auth": "YOUR_ACCESS_TOKEN"}
transport = StreamableHttpTransport(
    url="{% if tenant.subdomain == 'localhost' %}http://localhost:8080/mcp/{% else %}http://{{ tenant.subdomain }}.localhost:8080/mcp/{% endif %}",
    headers=headers
)
client = Client(transport=transport)

# Discover products
result = await client.tools.get_products(brief="video ads")</pre>
                </div>
            </div>

            <div class="form-section">
                <h3>Active Tokens</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Each advertiser has their own API token
                </p>
                <!-- Token list would go here -->
            </div>
        </div>

        <!-- Users Settings -->
        <div id="users" class="settings-section">
            <div class="settings-header">
                <h2>Users & Access</h2>
                <p>Manage who can access this tenant's admin interface</p>
            </div>

            <div class="form-section">
                <h3>Authorized Users</h3>
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/users">
                    <div class="form-group">
                        <label for="authorized_emails">Authorized Email Addresses</label>
                        <textarea id="authorized_emails" name="authorized_emails" rows="5"
                                  placeholder="user1@example.com&#10;user2@example.com">{{ '\n'.join(tenant.authorized_emails or []) }}</textarea>
                        <small>One email address per line</small>
                    </div>

                    <div class="form-group">
                        <label for="authorized_domains">Authorized Email Domains</label>
                        <textarea id="authorized_domains" name="authorized_domains" rows="3"
                                  placeholder="example.com&#10;company.org">{{ '\n'.join(tenant.authorized_domains or []) }}</textarea>
                        <small>Anyone with these email domains can access</small>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Update Access</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>Tenant Login URL</h3>
                <div class="config-code">
                    <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                    <pre style="margin: 0;">http://localhost:{{ admin_port }}/tenant/{{ tenant.tenant_id }}/login</pre>
                </div>
                <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    Share this URL with authorized users to access this tenant directly
                </p>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div id="advanced" class="settings-section">
            <div class="settings-header">
                <h2>Advanced Settings</h2>
                <p>Expert configuration and raw JSON editing</p>
            </div>

            <div class="status-card warning">
                <strong>‚ö†Ô∏è Warning</strong>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">
                    Modifying these settings incorrectly may break your configuration
                </p>
            </div>

            <div class="form-section">
                <h3>Raw Configuration (JSON)</h3>
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/raw">
                    <div class="form-group">
                        <textarea id="raw_config" name="config" rows="20"
                                  style="font-family: monospace;">{{ tenant.config_json }}</textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                        <button type="button" onclick="formatJSON()" class="btn btn-secondary">Format JSON</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- AI Settings -->
        <div id="ai" class="settings-section">
            <div class="settings-header">
                <h2>AI Settings</h2>
                <p>Configure AI prompt templates for product ranking</p>
            </div>

            <div class="form-section">
                <h3>AI Prompt Configuration</h3>
                <p class="text-muted mb-4">
                    Customize the AI prompt template used for product ranking. 
                    Leave empty to use the default template.
                </p>
                
                <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/ai">
                    <div class="form-group">
                        <label for="prompt_template">Prompt Template</label>
                        <textarea 
                            class="form-control" 
                            id="prompt_template" 
                            name="prompt_template" 
                            rows="15" 
                            placeholder="Enter your custom AI prompt template here..."
                        >{{ tenant.ai_prompt_template or '' }}</textarea>
                        <div class="form-text">
                            <strong>Required placeholders:</strong> {{PROMPT}}, {{PRODUCTS_JSON}}, {{MAX_RESULTS}}<br>
                            <strong>Optional placeholders:</strong> {{LOCALE}}, {{CURRENCY}}
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Save Template
                        </button>
                        
                        <button type="button" class="btn btn-secondary" onclick="previewTemplate()">
                            <i class="fas fa-eye me-1"></i>
                            Preview
                        </button>
                        
                        <form method="POST" action="/tenant/{{ tenant.tenant_id }}/settings/ai/reset" style="display: inline;">
                            <button type="submit" class="btn btn-outline-warning" 
                                    onclick="return confirm('Reset to default template?')">
                                <i class="fas fa-undo me-1"></i>
                                Reset to Default
                            </button>
                        </form>
                    </div>
                </form>
                
                <div id="preview-result" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Preview Result</h6>
                        </div>
                        <div class="card-body">
                            <pre id="preview-content" class="bg-light p-3 rounded"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Navigation
document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();

        // Update active nav
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');

        // Show corresponding section
        const sectionId = this.dataset.section;
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');

        // Update URL without reload
        history.pushState(null, '', `#${sectionId}`);
    });
});

// Load section from URL hash
window.addEventListener('load', function() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        const navItem = document.querySelector(`[data-section="${hash}"]`);
        if (navItem) {
            navItem.click();
        }
    }
});

// Copy to clipboard
function copyToClipboard(button) {
    const code = button.parentElement.querySelector('pre').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    });
}

// Format JSON
function formatJSON() {
    const textarea = document.getElementById('raw_config');
    try {
        const json = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(json, null, 2);
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

// Preview AI template
function previewTemplate() {
    const template = document.getElementById('prompt_template').value;
    const previewResult = document.getElementById('preview-result');
    const previewContent = document.getElementById('preview-content');
    
    fetch('/tenant/{{ tenant.tenant_id }}/settings/ai/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `prompt_template=${encodeURIComponent(template)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewContent.textContent = data.compiled_preview;
            previewResult.style.display = 'block';
        } else {
            alert('Preview failed: ' + data.errors.join(', '));
        }
    })
    .catch(error => {
        alert('Error generating preview: ' + error);
    });
}

// Test Slack
function testSlack() {
    const webhookUrl = document.getElementById('slack_webhook_url').value;
    if (!webhookUrl) {
        alert('Please enter a webhook URL first');
        return;
    }

    fetch('/tenant/{{ tenant.tenant_id }}/test_slack', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            webhook_url: webhookUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Test message sent successfully! Check your Slack channel.');
        } else {
            alert('Failed to send test message: ' + (data.error || 'Unknown error'));
        }
    });
}

// Select adapter
function selectAdapter(adapterName) {
    console.log('Switching to adapter:', adapterName);

    // Show confirmation dialog
    if (!confirm(`Are you sure you want to switch to ${adapterName}? This will change how ads are served.`)) {
        return;
    }

    // Send request to update adapter
    fetch(`/tenant/{{ tenant.tenant_id }}/settings/adapter`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            adapter: adapterName
        })
    })
    .then(response => {
        if (response.ok) {
            // Reload the page to show new adapter configuration
            window.location.reload();
        } else {
            return response.text().then(text => {
                throw new Error(text || 'Failed to switch adapter');
            });
        }
    })
    .catch(error => {
        console.error('Error switching adapter:', error);
        alert('Failed to switch adapter: ' + error.message);
    });
}

// Check OAuth configuration on page load
window.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('oauth-status')) {
        checkOAuthConfig();
    }
});

// Check if OAuth is properly configured
function checkOAuthConfig() {
    fetch('/api/oauth/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('oauth-status');
            if (data.configured) {
                statusDiv.style.background = '#f0f9ff';
                statusDiv.style.borderLeftColor = '#0066cc';
                statusDiv.innerHTML = `
                    <h4>‚úÖ OAuth Setup Complete</h4>
                    <p>OAuth credentials are configured. You can proceed with GAM setup.</p>
                    <small>Client ID: ${data.client_id_prefix}...</small>
                `;
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.borderLeftColor = '#ffc107';
                statusDiv.innerHTML = `
                    <h4>‚ö†Ô∏è OAuth Setup Required</h4>
                    <p><strong>Before configuring GAM, you need to set up OAuth credentials:</strong></p>
                    <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Set <code>GOOGLE_CLIENT_ID</code> and <code>GOOGLE_CLIENT_SECRET</code> environment variables</li>
                        <li>Ensure the OAuth app has Google Ad Manager API access enabled</li>
                        <li>The OAuth app must be authorized for your Google Workspace domain</li>
                    </ol>
                    <p><strong>Error:</strong> ${data.error || 'OAuth credentials not found'}</p>
                `;
                // Disable GAM configuration if OAuth not set up
                const gamFields = document.querySelectorAll('#gam_refresh_token, #detect-network-btn, button[onclick="saveGAMConfig()"]');
                gamFields.forEach(field => field.disabled = true);
            }
        })
        .catch(error => {
            console.error('Error checking OAuth config:', error);
            const statusDiv = document.getElementById('oauth-status');
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeftColor = '#dc3545';
            statusDiv.innerHTML = `
                <h4>‚ùå Error Checking OAuth Status</h4>
                <p>Could not verify OAuth configuration: ${error.message}</p>
            `;
        });
}

// Auto-detect GAM network code from refresh token
function detectGAMNetwork() {
    const refreshToken = document.getElementById('gam_refresh_token').value;

    if (!refreshToken) {
        alert('Please enter a refresh token first');
        return;
    }

    const detectBtn = document.getElementById('detect-network-btn');
    detectBtn.disabled = true;
    detectBtn.textContent = 'Detecting...';

    fetch('/tenant/{{ tenant.tenant_id }}/gam/detect-network', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refresh_token: refreshToken })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the network code field
            document.getElementById('gam_network_code').value = data.network_code;
            document.getElementById('gam_network_code').removeAttribute('readonly');

            // Update trafficker_id field if detected
            if (data.trafficker_id) {
                document.getElementById('gam_trafficker_id').value = data.trafficker_id;
            }

            // Show success message inline instead of alert
            const networkField = document.getElementById('gam_network_code').parentElement.parentElement;

            // Remove any existing alerts
            const existingAlert = networkField.querySelector('.alert-success');
            if (existingAlert) existingAlert.remove();

            // Create success message
            const networkInfo = document.createElement('div');
            networkInfo.className = 'alert alert-success';
            networkInfo.style.marginTop = '1rem';
            networkInfo.innerHTML = `
                <strong>‚úÖ Network Detected Successfully!</strong><br>
                <strong>Network:</strong> ${data.network_name}<br>
                <strong>Code:</strong> ${data.network_code}
                ${data.trafficker_id ? `<br><strong>User ID:</strong> ${data.trafficker_id}` : ''}
                ${data.network_count > 1 ? `<br><small>Note: You have access to ${data.network_count} networks. Using the primary one.</small>` : ''}
            `;
            networkField.appendChild(networkInfo);
        } else {
            // Show error inline instead of alert
            const networkField = document.getElementById('gam_network_code').parentElement.parentElement;

            // Remove any existing alerts
            const existingAlert = networkField.querySelector('.alert-danger');
            if (existingAlert) existingAlert.remove();

            // Create error message
            const errorInfo = document.createElement('div');
            errorInfo.className = 'alert alert-danger';
            errorInfo.style.marginTop = '1rem';
            errorInfo.innerHTML = `
                <strong>‚ùå Failed to detect network</strong><br>
                ${data.error || 'Unknown error'}
            `;
            networkField.appendChild(errorInfo);
        }
    })
    .catch(error => {
        console.error('Error detecting network:', error);
        alert('Failed to detect network: ' + error.message);
    })
    .finally(() => {
        detectBtn.disabled = false;
        detectBtn.textContent = 'Auto-detect Network';
    });
}

// Save GAM configuration
function saveGAMConfig() {
    const networkCode = document.getElementById('gam_network_code').value;
    const refreshToken = document.getElementById('gam_refresh_token').value;
    const traffickerId = document.getElementById('gam_trafficker_id').value;

    if (!refreshToken) {
        alert('Please provide a Refresh Token');
        return;
    }

    // Network code is optional - can be auto-detected
    if (!networkCode && !confirm('Network code not set. Would you like to auto-detect it first?')) {
        detectGAMNetwork();
        return;
    }

    // Trafficker ID is required for creating line items
    if (!traffickerId) {
        if (confirm('Trafficker ID is not set. This is required for creating line items. Would you like to auto-detect it?')) {
            detectGAMNetwork();
        }
        return;
    }

    fetch('/tenant/{{ tenant.tenant_id }}/gam/configure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            network_code: networkCode,
            refresh_token: refreshToken,
            trafficker_id: traffickerId
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(text || 'Failed to save configuration');
            });
        }
    })
    .then(data => {
        alert('GAM configuration saved successfully!');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error saving GAM config:', error);
        alert('Failed to save configuration: ' + error.message);
    });
}

// Test GAM connection
function testGAMConnection() {
    const refreshToken = document.getElementById('gam_refresh_token').value;

    if (!refreshToken) {
        alert('Please provide a refresh token first');
        return;
    }

    fetch('/api/gam/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            refresh_token: refreshToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = '‚úÖ GAM connection successful!';
            if (data.networks && data.networks.length > 0) {
                message += '\nNetwork: ' + data.networks[0].displayName;
                message += '\nCode: ' + data.networks[0].networkCode;
                if (data.networks.length > 1) {
                    message += '\n(You have access to ' + data.networks.length + ' networks)';
                }
            }
            alert(message);
        } else {
            alert('‚ùå GAM connection failed:\n' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error.message);
    });
}

// Load product template
function loadTemplate(templateType) {
    // Would load product template
    console.log('Loading template:', templateType);
}

// Sync inventory
function syncInventory() {
    // Would trigger inventory sync
    console.log('Syncing inventory...');
}
</script>
{% endblock %}
