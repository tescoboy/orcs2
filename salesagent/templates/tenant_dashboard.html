{% extends "base.html" %}

{% block title %}{{ tenant.name }} - Dashboard{% endblock %}

{% block content %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .metric-card.revenue::before { background: linear-gradient(90deg, #10b981, #34d399); }
    .metric-card.buys::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .metric-card.tasks::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .metric-card.advertisers::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }

    .metric-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
    }

    .metric-change {
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .metric-change.positive { color: #10b981; }
    .metric-change.negative { color: #ef4444; }
    .metric-change.neutral { color: #6b7280; }

    .dashboard-main {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .activity-feed {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 600px;
        display: flex;
        flex-direction: column;
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .activity-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .activity-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.active { background: #10b981; }
    .status-dot.idle { background: #6b7280; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .activity-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .activity-item {
        padding: 0.75rem;
        border-left: 3px solid transparent;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .activity-item:hover {
        background: #f9fafb;
    }

    .activity-item.api-call { border-left-color: #3b82f6; }
    .activity-item.media-buy { border-left-color: #10b981; }
    .activity-item.creative { border-left-color: #8b5cf6; }
    .activity-item.error { border-left-color: #ef4444; background: #fef2f2; }

    .activity-time {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-bottom: 0.25rem;
    }

    .activity-content {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .activity-principal {
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    .activity-action {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .activity-details {
        font-size: 0.75rem;
        color: #9ca3af;
        text-align: right;
    }

    .quick-actions {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .quick-actions h3 {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .action-grid {
        display: grid;
        gap: 0.75rem;
    }

    .action-button {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        text-decoration: none;
        color: #111827;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .action-button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateX(2px);
    }

    .action-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 1rem;
    }

    .action-icon.settings { background: #ede9fe; color: #7c3aed; }
    .action-icon.products { background: #dbeafe; color: #2563eb; }
    .action-icon.inventory { background: #d1fae5; color: #059669; }
    .action-icon.reports { background: #fed7aa; color: #ea580c; }

    .revenue-chart {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .chart-filters {
        display: flex;
        gap: 0.5rem;
    }

    .filter-button {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-button.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .media-buys-table {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .table-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .view-all-link {
        font-size: 0.875rem;
        color: #3b82f6;
        text-decoration: none;
    }

    .view-all-link:hover {
        text-decoration: underline;
    }

    .mini-table {
        width: 100%;
        font-size: 0.875rem;
    }

    .mini-table th {
        text-align: left;
        padding: 0.5rem;
        color: #6b7280;
        font-weight: 500;
        border-bottom: 1px solid #e5e7eb;
    }

    .mini-table td {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .advertiser-name {
        font-weight: 600;
        color: #111827;
    }

    .buy-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .buy-status.active { background: #d1fae5; color: #065f46; }
    .buy-status.pending { background: #fef3c7; color: #92400e; }
    .buy-status.completed { background: #e5e7eb; color: #374151; }

    .spend-amount {
        font-weight: 600;
        color: #111827;
    }

    @media (max-width: 1280px) {
        .dashboard-grid {
            grid-template-columns: 1fr 1fr;
        }

        .dashboard-main {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Header Section -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 style="margin: 0; font-size: 1.875rem; font-weight: 700; color: #111827;">{{ tenant.name }}</h1>
        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">
            Operational Dashboard ¬∑
            {% if tenant.ad_server %}{{ tenant.ad_server|title|replace('_', ' ') }}{% else %}No Ad Server{% endif %}
        </p>
    </div>
    <div style="display: flex; gap: 0.75rem;">
        <a href="/tenant/{{ tenant.tenant_id }}/settings" class="btn btn-secondary">
            <i class="fas fa-cog"></i> Settings
        </a>
        <button onclick="refreshDashboard()" class="btn">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="dashboard-grid">
    <div class="metric-card revenue">
        <div class="metric-label">Total Revenue (30d)</div>
        <div class="metric-value">${{ "{:,.0f}".format(metrics.total_revenue) }}</div>
        <div class="metric-change {{ 'positive' if metrics.revenue_change > 0 else 'negative' if metrics.revenue_change < 0 else 'neutral' }}">
            {% if metrics.revenue_change > 0 %}
                <i class="fas fa-arrow-up"></i>
            {% elif metrics.revenue_change < 0 %}
                <i class="fas fa-arrow-down"></i>
            {% else %}
                <i class="fas fa-minus"></i>
            {% endif %}
            {{ "{:.1f}".format(metrics.revenue_change_abs) }}% vs last period
        </div>
    </div>

    <div class="metric-card buys">
        <div class="metric-label">Active Media Buys</div>
        <div class="metric-value">{{ metrics.active_buys }}</div>
        <div class="metric-change neutral">
            {{ metrics.pending_buys }} pending approval
        </div>
    </div>

    <div class="metric-card tasks">
        <div class="metric-label">Open Tasks</div>
        <div class="metric-value">{{ metrics.open_tasks }}</div>
        <div class="metric-change {{ 'negative' if metrics.overdue_tasks > 0 else 'neutral' }}">
            {% if metrics.overdue_tasks > 0 %}
                <i class="fas fa-exclamation-triangle"></i>
                {{ metrics.overdue_tasks }} overdue
            {% else %}
                All on track
            {% endif %}
        </div>
    </div>

    <div class="metric-card advertisers">
        <div class="metric-label">Active Advertisers</div>
        <div class="metric-value">{{ metrics.active_advertisers }}</div>
        <div class="metric-change neutral">
            {{ metrics.total_advertisers }} total registered
        </div>
    </div>
</div>

<!-- Main Dashboard Area -->
<div class="dashboard-main">
    <!-- Activity Feed -->
    <div class="activity-feed">
        <div class="activity-header">
            <h3>Live Activity Feed</h3>
            <div class="activity-status">
                <span class="status-dot active"></span>
                <span id="connection-status">Connected</span>
            </div>
        </div>

        <div class="activity-list" id="activity-list">
            <!-- Activities will be added here via WebSocket -->
        </div>
    </div>

    <!-- Quick Actions -->
    <div>
        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <div class="action-grid">
                <a href="/tenant/{{ tenant.tenant_id }}/settings" class="action-button">
                    <div class="action-icon settings">‚öôÔ∏è</div>
                    <div>
                        <div style="font-weight: 600;">Configuration</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Ad server, products, formats</div>
                    </div>
                </a>

                <a href="/tenant/{{ tenant.tenant_id }}/products" class="action-button">
                    <div class="action-icon products">üì¶</div>
                    <div>
                        <div style="font-weight: 600;">Products</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">{{ product_count }} configured</div>
                    </div>
                </a>

                {% if tenant.ad_server == 'google_ad_manager' %}
                <a href="/tenant/{{ tenant.tenant_id }}/inventory" class="action-button">
                    <div class="action-icon inventory">üìä</div>
                    <div>
                        <div style="font-weight: 600;">GAM Inventory</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">View & sync</div>
                    </div>
                </a>
                {% endif %}

                <a href="/tenant/{{ tenant.tenant_id }}/reporting" class="action-button">
                    <div class="action-icon reports">üìà</div>
                    <div>
                        <div style="font-weight: 600;">Reports</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Performance data</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Pending Tasks -->
        {% if pending_tasks %}
        <div class="quick-actions" style="margin-top: 1rem;">
            <h3 style="color: #dc2626;">‚ö†Ô∏è Pending Tasks ({{ pending_tasks|length }})</h3>
            <div class="action-grid">
                {% for task in pending_tasks[:3] %}
                <div class="action-button" style="background: #fef2f2; border-color: #fecaca;">
                    <div>
                        <div style="font-weight: 600; color: #991b1b;">{{ task.type }}</div>
                        <div style="font-size: 0.75rem; color: #dc2626;">{{ task.description }}</div>
                    </div>
                </div>
                {% endfor %}
                {% if pending_tasks|length > 3 %}
                <a href="/tenant/{{ tenant.tenant_id }}/tasks" class="action-button">
                    <div>View all {{ pending_tasks|length }} tasks ‚Üí</div>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Revenue Chart -->
<div class="revenue-chart">
    <div class="chart-header">
        <h3>Revenue by Advertiser</h3>
        <div class="chart-filters">
            <button class="filter-button active" data-period="7d">7 Days</button>
            <button class="filter-button" data-period="30d">30 Days</button>
            <button class="filter-button" data-period="90d">90 Days</button>
        </div>
    </div>
    <canvas id="revenueChart" height="80"></canvas>
</div>

<!-- Recent Media Buys -->
<div class="media-buys-table">
    <div class="table-header">
        <h3>Recent Media Buys</h3>
        <a href="/operations" class="view-all-link">View all ‚Üí</a>
    </div>

    <table class="mini-table">
        <thead>
            <tr>
                <th>Advertiser</th>
                <th>Media Buy ID</th>
                <th>Status</th>
                <th>Budget</th>
                <th>Spend</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for buy in recent_media_buys[:5] %}
            <tr>
                <td class="advertiser-name">{{ buy.advertiser_name }}</td>
                <td><code style="font-size: 0.75rem;">{{ buy.media_buy_id }}</code></td>
                <td>
                    <span class="buy-status {{ buy.status }}">{{ buy.status|upper }}</span>
                </td>
                <td class="spend-amount">${{ "{:,.0f}".format(buy.budget) }}</td>
                <td>${{ "{:,.0f}".format(buy.spend) }}</td>
                <td style="color: #6b7280;">{{ buy.created_at_relative }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// WebSocket connection for real-time activity feed
let socket = null;
let activityBuffer = [];
const MAX_ACTIVITIES = 50;

function connectWebSocket() {
    // Connect to Socket.IO with tenant_id as query parameter
    socket = io(window.location.origin, {
        query: {
            tenant_id: '{{ tenant.tenant_id }}'
        },
        reconnection: true,
        reconnectionDelay: 5000
    });

    socket.on('connect', function() {
        console.log('Socket.IO connected');
        document.getElementById('connection-status').textContent = 'Connected';
        document.querySelector('.status-dot').classList.remove('idle');
        document.querySelector('.status-dot').classList.add('active');

        // Subscribe to this tenant's activities
        socket.emit('subscribe', { tenant_id: '{{ tenant.tenant_id }}' });
    });

    socket.on('activity', function(activity) {
        console.log('Received activity:', activity);
        addActivity(activity);
    });

    socket.on('disconnect', function() {
        console.log('Socket.IO disconnected');
        document.getElementById('connection-status').textContent = 'Disconnected';
        document.querySelector('.status-dot').classList.remove('active');
        document.querySelector('.status-dot').classList.add('idle');
    });

    socket.on('connect_error', function(error) {
        console.error('Socket.IO connection error:', error);
    });

    socket.on('subscribed', function(data) {
        console.log('Subscribed to tenant:', data.tenant_id);
    });
}

function addActivity(activity) {
    const list = document.getElementById('activity-list');

    // Create activity element
    const item = document.createElement('div');
    item.className = `activity-item ${activity.type}`;
    item.innerHTML = `
        <div class="activity-time">${activity.time_relative}</div>
        <div class="activity-content">
            <div>
                <div class="activity-principal">${activity.principal_name}</div>
                <div class="activity-action">${activity.action}</div>
            </div>
            <div class="activity-details">
                ${activity.details ? `
                    <div>${activity.details.primary}</div>
                    <div>${activity.details.secondary}</div>
                ` : ''}
            </div>
        </div>
    `;

    // Add to beginning of list
    list.insertBefore(item, list.firstChild);

    // Keep only MAX_ACTIVITIES items
    while (list.children.length > MAX_ACTIVITIES) {
        list.removeChild(list.lastChild);
    }

    // Store in buffer for persistence
    activityBuffer.unshift(activity);
    if (activityBuffer.length > MAX_ACTIVITIES) {
        activityBuffer.pop();
    }
}

// Revenue Chart
const ctx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ chart_labels | tojson }},
        datasets: [{
            label: 'Revenue',
            data: {{ chart_data | tojson }},
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Chart period filters
document.querySelectorAll('.filter-button').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Fetch new data based on period
        fetchChartData(this.dataset.period);
    });
});

function fetchChartData(period) {
    fetch(`/api/tenant/{{ tenant.tenant_id }}/revenue-chart?period=${period}`)
        .then(response => response.json())
        .then(data => {
            revenueChart.data.labels = data.labels;
            revenueChart.data.datasets[0].data = data.values;
            revenueChart.update();
        });
}

function refreshDashboard() {
    // Reload the page for now, could be enhanced with AJAX updates
    window.location.reload();
}

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (ws) {
        ws.close();
    }
});
</script>
{% endblock %}
