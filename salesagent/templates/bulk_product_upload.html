{% extends "base.html" %}

{% block title %}Bulk Product Upload - AdCP Admin{% endblock %}

{% block content %}
<div class="card">
    <h2>Bulk Product Upload</h2>

    <div class="alert alert-info">
        <strong>Bulk Import:</strong> Upload multiple products at once using CSV or JSON format. You can also use pre-built templates.
    </div>

    <!-- Upload Options Tabs -->
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('csv')">CSV Upload</button>
        <button class="tab-button" onclick="showTab('json')">JSON Upload</button>
        <button class="tab-button" onclick="showTab('templates')">Use Templates</button>
        <button class="tab-button" onclick="showTab('paste')">Paste Data</button>
    </div>

    <!-- CSV Upload Tab -->
    <div id="csv-tab" class="tab-content active">
        <h3>Upload CSV File</h3>

        <div class="form-group">
            <label>Download Template:</label>
            <button class="btn btn-secondary" onclick="downloadCSVTemplate()">Download CSV Template</button>
        </div>

        <form id="csv-upload-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="csv-file">Select CSV File:</label>
                <input type="file" id="csv-file" name="file" accept=".csv" required>
            </div>

            <div class="csv-requirements">
                <h4>CSV Format Requirements:</h4>
                <ul>
                    <li><strong>name</strong> (required): Product name</li>
                    <li><strong>product_id</strong>: Unique ID (auto-generated from name if empty)</li>
                    <li><strong>description</strong>: Product description</li>
                    <li><strong>formats</strong>: Comma-separated format IDs (e.g., "display_300x250,display_728x90")</li>
                    <li><strong>delivery_type</strong>: "guaranteed" or "non_guaranteed"</li>
                    <li><strong>cpm</strong>: CPM price for guaranteed products</li>
                    <li><strong>price_guidance_min</strong>: Minimum CPM for non-guaranteed</li>
                    <li><strong>price_guidance_max</strong>: Maximum CPM for non-guaranteed</li>
                    <li><strong>countries</strong>: Comma-separated country codes (e.g., "US,CA,GB")</li>
                    <li><strong>device_types</strong>: Comma-separated device types (e.g., "desktop,mobile")</li>
                </ul>
            </div>

            <button type="submit" class="btn btn-primary">Upload CSV</button>
        </form>
    </div>

    <!-- JSON Upload Tab -->
    <div id="json-tab" class="tab-content">
        <h3>Upload JSON File</h3>

        <div class="form-group">
            <label>Download Template:</label>
            <button class="btn btn-secondary" onclick="downloadJSONTemplate()">Download JSON Template</button>
        </div>

        <form id="json-upload-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="json-file">Select JSON File:</label>
                <input type="file" id="json-file" name="file" accept=".json" required>
            </div>

            <button type="submit" class="btn btn-primary">Upload JSON</button>
        </form>
    </div>

    <!-- Templates Tab -->
    <div id="templates-tab" class="tab-content">
        <h3>Use Product Templates</h3>

        <div class="template-selector">
            <div class="form-group">
                <label>Select Templates to Import:</label>
                <div class="template-list">
                    {% for template in templates %}
                    <div class="template-item">
                        <input type="checkbox" id="template_{{ template.product_id }}"
                               name="templates" value="{{ template.product_id }}"
                               data-template='{{ template | tojson }}'>
                        <label for="template_{{ template.product_id }}">
                            <strong>{{ template.name }}</strong>
                            <span class="template-type">{{ template.delivery_type }}</span>
                            {% if template.cpm %}
                                <span class="template-price">${{ template.cpm }} CPM</span>
                            {% else %}
                                <span class="template-price">${{ template.price_guidance.min }}-${{ template.price_guidance.max }} CPM</span>
                            {% endif %}
                            <div class="template-description">{{ template.description }}</div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <button class="btn btn-secondary" onclick="loadIndustryTemplates()">Load Industry-Specific Templates</button>
            </div>

            <button type="button" class="btn btn-primary" onclick="importSelectedTemplates()">Import Selected Templates</button>
        </div>
    </div>

    <!-- Paste Data Tab -->
    <div id="paste-tab" class="tab-content">
        <h3>Paste Product Data</h3>

        <form id="paste-form">
            <div class="form-group">
                <label for="paste-format">Data Format:</label>
                <select id="paste-format" name="format">
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                </select>
            </div>

            <div class="form-group">
                <label for="paste-data">Paste your data here:</label>
                <textarea id="paste-data" name="data" rows="15"
                    placeholder='[{"name": "Homepage Banner", "formats": ["display_728x90"], ...}]'></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Import Data</button>
        </form>
    </div>

    <!-- Results Section -->
    <div id="upload-results" style="display: none; margin-top: 2rem;">
        <h3>Import Results</h3>
        <div id="results-content"></div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.tab-button {
    padding: 10px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.tab-button:hover {
    background: #f5f5f5;
}

.tab-button.active {
    border-bottom-color: #007bff;
    color: #007bff;
    font-weight: 600;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.csv-requirements {
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
}

.csv-requirements h4 {
    margin-top: 0;
}

.csv-requirements ul {
    margin-bottom: 0;
}

.template-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 1rem;
}

.template-item {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.template-item:last-child {
    border-bottom: none;
}

.template-item input[type="checkbox"] {
    margin-right: 10px;
}

.template-item label {
    display: block;
    cursor: pointer;
}

.template-type {
    display: inline-block;
    background: #e0e0e0;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.85rem;
    margin-left: 10px;
}

.template-price {
    display: inline-block;
    color: #28a745;
    font-weight: 600;
    margin-left: 10px;
}

.template-description {
    color: #666;
    font-size: 0.9rem;
    margin-top: 5px;
}

#paste-data {
    font-family: monospace;
    font-size: 14px;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}
</style>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}

function downloadCSVTemplate() {
    const csvContent = `name,product_id,description,formats,delivery_type,cpm,price_guidance_min,price_guidance_max,countries,device_types
"Homepage Banner","","Premium homepage placement","display_728x90,display_970x250","guaranteed",25.0,,,"US,CA,GB","desktop,mobile"
"Run of Site Display","","Standard display advertising","display_300x250,display_728x90","non_guaranteed",,2.0,10.0,,"desktop,mobile,tablet"
"Mobile Interstitial","","Full-screen mobile ads","display_320x480","guaranteed",15.0,,,"US","mobile"`;

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'product_upload_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function downloadJSONTemplate() {
    const jsonContent = JSON.stringify([
        {
            "name": "Homepage Banner",
            "description": "Premium homepage placement",
            "formats": ["display_728x90", "display_970x250"],
            "delivery_type": "guaranteed",
            "cpm": 25.0,
            "countries": ["US", "CA", "GB"],
            "device_types": ["desktop", "mobile"]
        },
        {
            "name": "Run of Site Display",
            "description": "Standard display advertising",
            "formats": ["display_300x250", "display_728x90"],
            "delivery_type": "non_guaranteed",
            "price_guidance_min": 2.0,
            "price_guidance_max": 10.0,
            "device_types": ["desktop", "mobile", "tablet"]
        }
    ], null, 2);

    const blob = new Blob([jsonContent], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'product_upload_template.json';
    a.click();
    window.URL.revokeObjectURL(url);
}

async function loadIndustryTemplates() {
    try {
        const response = await fetch(`{{ url_for('products.get_templates', tenant_id=tenant_id) }}`);
        const data = await response.json();

        if (data.templates) {
            alert(`Loaded ${data.templates.length} industry-specific templates`);
            // Reload page to show new templates
            window.location.reload();
        }
    } catch (error) {
        alert('Error loading templates: ' + error.message);
    }
}

function importSelectedTemplates() {
    const selected = [];
    document.querySelectorAll('input[name="templates"]:checked').forEach(checkbox => {
        selected.push(JSON.parse(checkbox.dataset.template));
    });

    if (selected.length === 0) {
        alert('Please select at least one template');
        return;
    }

    uploadProducts(selected);
}

async function uploadProducts(products) {
    try {
        const response = await fetch(`{{ url_for('products.bulk_upload', tenant_id=tenant_id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ products: products })
        });

        const result = await response.json();
        displayResults(result);

    } catch (error) {
        displayResults({ error: error.message });
    }
}

function displayResults(result) {
    const resultsDiv = document.getElementById('upload-results');
    const contentDiv = document.getElementById('results-content');

    resultsDiv.style.display = 'block';

    // Clear content safely
    contentDiv.innerHTML = '';

    if (result.error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-error';
        errorDiv.textContent = 'Error: ' + result.error;
        contentDiv.appendChild(errorDiv);
    } else {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success';
        successDiv.textContent = `Successfully created ${result.created} products`;
        contentDiv.appendChild(successDiv);

        if (result.errors && result.errors.length > 0) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';

            const strong = document.createElement('strong');
            strong.textContent = 'Errors:';
            errorDiv.appendChild(strong);

            const ul = document.createElement('ul');
            result.errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                ul.appendChild(li);
            });
            errorDiv.appendChild(ul);
            contentDiv.appendChild(errorDiv);
        }

        // Redirect to products list after 3 seconds
        if (result.created > 0) {
            setTimeout(() => {
                window.location.href = `{{ url_for('products.list_products', tenant_id=tenant_id) }}`;
            }, 3000);
        }
    }
}

// Handle CSV upload
document.getElementById('csv-upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append('file', document.getElementById('csv-file').files[0]);

    try {
        const response = await fetch(`{{ url_for('products.bulk_upload', tenant_id=tenant_id) }}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        displayResults(result);

    } catch (error) {
        displayResults({ error: error.message });
    }
});

// Handle JSON upload
document.getElementById('json-upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append('file', document.getElementById('json-file').files[0]);

    try {
        const response = await fetch(`{{ url_for('products.bulk_upload', tenant_id=tenant_id) }}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        displayResults(result);

    } catch (error) {
        displayResults({ error: error.message });
    }
});

// Handle paste form
document.getElementById('paste-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const format = document.getElementById('paste-format').value;
    const data = document.getElementById('paste-data').value;

    let products;
    try {
        if (format === 'json') {
            products = JSON.parse(data);
        } else {
            // Parse CSV - simple implementation
            const lines = data.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            products = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^,]+)/g).map(v => v.trim().replace(/"/g, ''));
                const product = {};
                headers.forEach((header, idx) => {
                    if (values[idx]) {
                        product[header] = values[idx];
                    }
                });
                products.push(product);
            }
        }

        uploadProducts(products);

    } catch (error) {
        displayResults({ error: 'Invalid data format: ' + error.message });
    }
});
</script>
{% endblock %}
