# Fly.io Dockerfile for AdCP Sales Agent with ADK
FROM python:3.12-slim

# Install dependencies including nginx
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    gcc \
    libpq-dev \
    nginx \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages
RUN pip install uv

WORKDIR /app

# Copy and install dependencies
COPY pyproject.toml uv.lock ./
RUN uv sync

# Copy application
COPY . .

# Copy nginx configuration
COPY config/nginx/nginx.conf /etc/nginx/nginx.conf

# Add .venv to PATH
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1

# Service ports
ENV ADCP_SALES_PORT=8080
ENV ADMIN_UI_PORT=8001
ENV ADK_WEB_PORT=8091

# Make scripts executable
RUN chmod +x scripts/deploy/run_all_services.py scripts/deploy/entrypoint.sh

# Health check for nginx proxy
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Expose only the unified nginx port
EXPOSE 8000

# Run all services via entrypoint which handles migrations
ENTRYPOINT ["/bin/bash", "scripts/deploy/entrypoint.sh"]
